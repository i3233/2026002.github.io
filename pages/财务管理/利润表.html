<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ©æ¶¦è¡¨ - 2026æ–°é¡¹ç›®äºŒ</title>
    <link rel="stylesheet" href="../../css/Main.css">
    <style>
        .profit-statement-page {
            padding: var(--spacing-lg);
            background-color: var(--color-neutral-50);
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .page-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* é¡¶éƒ¨æ“ä½œæŒ‰é’®æ  */
        .toolbar-card {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .btn-icon-text {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-icon-text-symbol {
            font-size: 14px;
        }

        /* ç­›é€‰æ¡ä»¶åŒºåŸŸ */
        .filter-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .filter-row {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: var(--spacing-md);
        }

        .filter-item {
            flex: 1;
            min-width: 150px;
        }

        .filter-item label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .filter-item input,
        .filter-item select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-input-focus);
        }

        .filter-item--date-range {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .filter-item--date-range > div {
            flex: 1;
        }

        .filter-item--date-range span {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .filter-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-neutral-200);
        }

        /* ç»Ÿè®¡æ‘˜è¦åŒºåŸŸ */
        .summary-row {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 180px;
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-md) var(--spacing-lg);
            position: relative;
        }

        .summary-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .summary-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: baseline;
            gap: var(--spacing-xs);
        }

        .summary-value-blue {
            color: var(--color-primary);
        }

        .summary-value-green {
            color: var(--color-success);
        }

        .summary-value-red {
            color: var(--color-error);
        }

        .summary-indicator {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .summary-indicator.blue {
            background-color: var(--color-primary);
        }

        .summary-indicator.green {
            background-color: var(--color-success);
        }

        .summary-indicator.red {
            background-color: var(--color-error);
        }

        /* åˆ©æ¶¦è¡¨è¡¨æ ¼ */
        .profit-table-container {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--color-neutral-50);
        }

        th, td {
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: var(--font-size-sm);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        th {
            text-align: left;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        tbody tr {
            transition: all var(--transition-base) var(--ease-in-out);
        }

        tbody tr:hover {
            background-color: var(--color-neutral-50);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* åˆ©æ¶¦è¡¨ç‰¹æ®Šæ ·å¼ */
        .profit-item-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            padding-left: var(--spacing-md);
        }

        .profit-item-name.main {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            padding-left: 0;
        }

        .profit-item-name.sub {
            padding-left: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        .profit-item-name.sub-sub {
            padding-left: calc(var(--spacing-xl) * 2);
            color: var(--color-text-secondary);
            font-size: var(--font-size-xs);
        }

        .profit-amount {
            text-align: right;
            font-weight: var(--font-weight-medium);
            font-family: 'Courier New', monospace;
        }

        .profit-amount.positive {
            color: var(--color-success);
        }

        .profit-amount.negative {
            color: var(--color-error);
        }

        .profit-amount.main {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
        }

        .profit-section-row {
            background-color: var(--color-neutral-50);
            font-weight: var(--font-weight-bold);
        }

        .profit-total-row {
            background-color: rgba(44, 131, 235, 0.1);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
        }

        .profit-final-row {
            background-color: rgba(40, 167, 69, 0.1);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }

        .text-right {
            text-align: right;
        }

        .text-secondary {
            color: var(--color-text-secondary);
        }

        /* è¯´æ˜æ–‡å­— */
        .profit-note {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        .profit-note-title {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--color-text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        @media (max-width: 1200px) {
            .toolbar-card {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-item {
                width: 100%;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-xs);
            }
        }
    </style>
</head>
<body>
    <div class="profit-statement-page">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <div>
                <h1 class="page-title">åˆ©æ¶¦è¡¨</h1>
                <div class="page-subtitle">æŸ¥çœ‹è¥ä¸šæ”¶å…¥ã€æˆæœ¬ã€è´¹ç”¨åŠåˆ©æ¶¦æƒ…å†µ</div>
            </div>
        </div>

        <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’®æ  -->
        <div class="toolbar-card">
            <div class="toolbar-left">
                <button class="btn btn-outline" id="exportBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">â†‘</span>
                        <span>å¯¼å‡º</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="printBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">ğŸ–¨</span>
                        <span>æ‰“å°</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="summaryBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">ğŸ“Š</span>
                        <span>åˆ©æ¶¦æ±‡æ€»</span>
                    </span>
                </button>
            </div>
        </div>

        <!-- ç­›é€‰æ¡ä»¶åŒºåŸŸ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>ç»Ÿè®¡å‘¨æœŸ</label>
                    <select id="periodSelect">
                        <option value="month" selected>æœ¬æœˆ</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="year">æœ¬å¹´</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="filter-item filter-item--date-range" id="dateRangeFilter" style="display: none;">
                    <div style="flex: 1;">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="dateStart">
                    </div>
                    <span>è‡³</span>
                    <div style="flex: 1;">
                        <label style="visibility: hidden;">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="dateEnd">
                    </div>
                </div>
                <div class="filter-item">
                    <label>éƒ¨é—¨</label>
                    <select id="departmentSelect">
                        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                        <option value="sales">é”€å”®éƒ¨</option>
                        <option value="online">çº¿ä¸Šé”€å”®éƒ¨</option>
                        <option value="wholesale">æ‰¹å‘éƒ¨</option>
                        <option value="store">é—¨åº—éƒ¨</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" id="searchBtn">æŸ¥è¯¢</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ‘˜è¦åŒºåŸŸ -->
        <div class="summary-row">
            <div class="summary-card">
                <span class="summary-indicator blue"></span>
                <div class="summary-label">è¥ä¸šæ”¶å…¥(å…ƒ)</div>
                <div class="summary-value summary-value-blue" id="totalRevenue">0.00</div>
            </div>
            <div class="summary-card">
                <span class="summary-indicator red"></span>
                <div class="summary-label">è¥ä¸šæˆæœ¬(å…ƒ)</div>
                <div class="summary-value summary-value-red" id="totalCost">0.00</div>
            </div>
            <div class="summary-card">
                <span class="summary-indicator green"></span>
                <div class="summary-label">æ¯›åˆ©æ¶¦(å…ƒ)</div>
                <div class="summary-value summary-value-green" id="grossProfit">0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">æ¯›åˆ©ç‡(%)</div>
                <div class="summary-value summary-value-green" id="grossProfitRate">0.00</div>
            </div>
            <div class="summary-card">
                <span class="summary-indicator red"></span>
                <div class="summary-label">è¥ä¸šè´¹ç”¨(å…ƒ)</div>
                <div class="summary-value summary-value-red" id="operatingExpenses">0.00</div>
            </div>
            <div class="summary-card">
                <span class="summary-indicator green"></span>
                <div class="summary-label">è¥ä¸šåˆ©æ¶¦(å…ƒ)</div>
                <div class="summary-value summary-value-green" id="operatingProfit">0.00</div>
            </div>
            <div class="summary-card">
                <span class="summary-indicator green"></span>
                <div class="summary-label">å‡€åˆ©æ¶¦(å…ƒ)</div>
                <div class="summary-value summary-value-green" id="netProfit">0.00</div>
            </div>
        </div>

        <!-- åˆ©æ¶¦è¡¨è¡¨æ ¼ -->
        <div class="profit-table-container">
            <div class="table-wrapper">
                <table id="profitTable">
                    <thead>
                        <tr>
                            <th style="width: 40%;">é¡¹ç›®</th>
                            <th class="text-right" style="width: 30%;">é‡‘é¢(å…ƒ)</th>
                            <th class="text-right" style="width: 30%;">å æ¯”(%)</th>
                        </tr>
                    </thead>
                    <tbody id="profitTableBody">
                        <!-- JS æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è¯´æ˜æ–‡å­— -->
        <div class="profit-note">
            <div class="profit-note-title">è¯´æ˜ï¼š</div>
            <div>1. è¥ä¸šæ”¶å…¥ = æ‰€æœ‰è®¢å•é”€å”®æ”¶å…¥æ€»é¢ï¼ˆä¸å«ç¨ï¼‰</div>
            <div>2. è¥ä¸šæˆæœ¬ = å•†å“é‡‡è´­æˆæœ¬ + åº“å­˜æˆæœ¬</div>
            <div>3. æ¯›åˆ©æ¶¦ = è¥ä¸šæ”¶å…¥ - è¥ä¸šæˆæœ¬</div>
            <div>4. æ¯›åˆ©ç‡ = (æ¯›åˆ©æ¶¦ / è¥ä¸šæ”¶å…¥) Ã— 100%</div>
            <div>5. è¥ä¸šè´¹ç”¨ = é”€å”®è´¹ç”¨ + ç®¡ç†è´¹ç”¨ + è´¢åŠ¡è´¹ç”¨</div>
            <div>6. è¥ä¸šåˆ©æ¶¦ = æ¯›åˆ©æ¶¦ - è¥ä¸šè´¹ç”¨</div>
            <div>7. å‡€åˆ©æ¶¦ = è¥ä¸šåˆ©æ¶¦ + å…¶ä»–æ”¶å…¥ - å…¶ä»–æ”¯å‡º - æ‰€å¾—ç¨</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿåˆ©æ¶¦è¡¨æ•°æ®
        const profitData = {
            // è¥ä¸šæ”¶å…¥
            revenue: {
                onlineSales: 720000.00,      // çº¿ä¸Šé”€å”®
                storeSales: 480000.00,        // é—¨åº—é”€å”®
                wholesaleSales: 650000.00,    // æ‰¹å‘é”€å”®
                otherRevenue: 50000.00         // å…¶ä»–æ”¶å…¥
            },
            // è¥ä¸šæˆæœ¬
            cost: {
                purchaseCost: 1200000.00,     // é‡‡è´­æˆæœ¬
                inventoryCost: 150000.00,     // åº“å­˜æˆæœ¬
                otherCost: 50000.00           // å…¶ä»–æˆæœ¬
            },
            // è¥ä¸šè´¹ç”¨
            expenses: {
                salesExpenses: 85000.00,      // é”€å”®è´¹ç”¨
                managementExpenses: 65000.00, // ç®¡ç†è´¹ç”¨
                financialExpenses: 12000.00,  // è´¢åŠ¡è´¹ç”¨
                otherExpenses: 8000.00        // å…¶ä»–è´¹ç”¨
            },
            // å…¶ä»–æ”¶æ”¯
            other: {
                otherIncome: 30000.00,        // å…¶ä»–æ”¶å…¥
                otherExpense: 15000.00,       // å…¶ä»–æ”¯å‡º
                tax: 25000.00                 // æ‰€å¾—ç¨
            }
        };

        // åˆå§‹åŒ–
        function init() {
            renderProfitTable();
            updateSummary();
            bindEvents();
        }

        // è®¡ç®—åˆ©æ¶¦è¡¨æ•°æ®
        function calculateProfitData() {
            // è¥ä¸šæ”¶å…¥åˆè®¡
            const totalRevenue = 
                profitData.revenue.onlineSales +
                profitData.revenue.storeSales +
                profitData.revenue.wholesaleSales +
                profitData.revenue.otherRevenue;

            // è¥ä¸šæˆæœ¬åˆè®¡
            const totalCost = 
                profitData.cost.purchaseCost +
                profitData.cost.inventoryCost +
                profitData.cost.otherCost;

            // æ¯›åˆ©æ¶¦
            const grossProfit = totalRevenue - totalCost;

            // æ¯›åˆ©ç‡
            const grossProfitRate = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;

            // è¥ä¸šè´¹ç”¨åˆè®¡
            const totalExpenses = 
                profitData.expenses.salesExpenses +
                profitData.expenses.managementExpenses +
                profitData.expenses.financialExpenses +
                profitData.expenses.otherExpenses;

            // è¥ä¸šåˆ©æ¶¦
            const operatingProfit = grossProfit - totalExpenses;

            // å‡€åˆ©æ¶¦
            const netProfit = 
                operatingProfit +
                profitData.other.otherIncome -
                profitData.other.otherExpense -
                profitData.other.tax;

            return {
                totalRevenue,
                totalCost,
                grossProfit,
                grossProfitRate,
                totalExpenses,
                operatingProfit,
                netProfit
            };
        }

        // æ¸²æŸ“åˆ©æ¶¦è¡¨
        function renderProfitTable() {
            const tbody = document.getElementById('profitTableBody');
            tbody.innerHTML = '';

            const calculated = calculateProfitData();

            // ä¸€ã€è¥ä¸šæ”¶å…¥
            addSectionRow(tbody, 'ä¸€ã€è¥ä¸šæ”¶å…¥');
            addDataRow(tbody, 'çº¿ä¸Šé”€å”®æ”¶å…¥', profitData.revenue.onlineSales, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'é—¨åº—é”€å”®æ”¶å…¥', profitData.revenue.storeSales, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'æ‰¹å‘é”€å”®æ”¶å…¥', profitData.revenue.wholesaleSales, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'å…¶ä»–æ”¶å…¥', profitData.revenue.otherRevenue, calculated.totalRevenue, 'sub');
            addTotalRow(tbody, 'è¥ä¸šæ”¶å…¥åˆè®¡', calculated.totalRevenue, calculated.totalRevenue, 'main');

            // äºŒã€è¥ä¸šæˆæœ¬
            addSectionRow(tbody, 'äºŒã€è¥ä¸šæˆæœ¬');
            addDataRow(tbody, 'å•†å“é‡‡è´­æˆæœ¬', profitData.cost.purchaseCost, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'åº“å­˜æˆæœ¬', profitData.cost.inventoryCost, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'å…¶ä»–æˆæœ¬', profitData.cost.otherCost, calculated.totalRevenue, 'sub');
            addTotalRow(tbody, 'è¥ä¸šæˆæœ¬åˆè®¡', calculated.totalCost, calculated.totalRevenue, 'main');

            // ä¸‰ã€æ¯›åˆ©æ¶¦
            addTotalRow(tbody, 'ä¸‰ã€æ¯›åˆ©æ¶¦', calculated.grossProfit, calculated.totalRevenue, 'main', true);

            // å››ã€è¥ä¸šè´¹ç”¨
            addSectionRow(tbody, 'å››ã€è¥ä¸šè´¹ç”¨');
            addDataRow(tbody, 'é”€å”®è´¹ç”¨', profitData.expenses.salesExpenses, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'ç®¡ç†è´¹ç”¨', profitData.expenses.managementExpenses, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'è´¢åŠ¡è´¹ç”¨', profitData.expenses.financialExpenses, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'å…¶ä»–è´¹ç”¨', profitData.expenses.otherExpenses, calculated.totalRevenue, 'sub');
            addTotalRow(tbody, 'è¥ä¸šè´¹ç”¨åˆè®¡', calculated.totalExpenses, calculated.totalRevenue, 'main');

            // äº”ã€è¥ä¸šåˆ©æ¶¦
            addTotalRow(tbody, 'äº”ã€è¥ä¸šåˆ©æ¶¦', calculated.operatingProfit, calculated.totalRevenue, 'main', true);

            // å…­ã€å…¶ä»–æ”¶æ”¯
            addSectionRow(tbody, 'å…­ã€å…¶ä»–æ”¶æ”¯');
            addDataRow(tbody, 'å…¶ä»–æ”¶å…¥', profitData.other.otherIncome, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'å…¶ä»–æ”¯å‡º', -profitData.other.otherExpense, calculated.totalRevenue, 'sub');
            addDataRow(tbody, 'æ‰€å¾—ç¨', -profitData.other.tax, calculated.totalRevenue, 'sub');

            // ä¸ƒã€å‡€åˆ©æ¶¦
            addFinalRow(tbody, 'ä¸ƒã€å‡€åˆ©æ¶¦', calculated.netProfit, calculated.totalRevenue, true);
        }

        // æ·»åŠ åˆ†ç»„è¡Œ
        function addSectionRow(tbody, text) {
            const row = document.createElement('tr');
            row.className = 'profit-section-row';
            row.innerHTML = `
                <td class="profit-item-name main">${text}</td>
                <td></td>
                <td></td>
            `;
            tbody.appendChild(row);
        }

        // æ·»åŠ æ•°æ®è¡Œ
        function addDataRow(tbody, name, amount, totalRevenue, level = 'sub') {
            const row = document.createElement('tr');
            const percentage = totalRevenue > 0 ? (Math.abs(amount) / totalRevenue) * 100 : 0;
            const amountClass = amount >= 0 ? 'positive' : 'negative';
            
            row.innerHTML = `
                <td class="profit-item-name ${level}">${name}</td>
                <td class="profit-amount ${amountClass}">${amount >= 0 ? '+' : ''}${amount.toFixed(2)}</td>
                <td class="profit-amount ${amountClass}">${percentage.toFixed(2)}%</td>
            `;
            tbody.appendChild(row);
        }

        // æ·»åŠ åˆè®¡è¡Œ
        function addTotalRow(tbody, name, amount, totalRevenue, level = 'main', isProfit = false) {
            const row = document.createElement('tr');
            row.className = isProfit ? 'profit-total-row' : '';
            const percentage = totalRevenue > 0 ? (Math.abs(amount) / totalRevenue) * 100 : 0;
            const amountClass = amount >= 0 ? 'positive' : 'negative';
            
            row.innerHTML = `
                <td class="profit-item-name ${level}">${name}</td>
                <td class="profit-amount main ${amountClass}">${amount >= 0 ? '+' : ''}${amount.toFixed(2)}</td>
                <td class="profit-amount main ${amountClass}">${percentage.toFixed(2)}%</td>
            `;
            tbody.appendChild(row);
        }

        // æ·»åŠ æœ€ç»ˆè¡Œï¼ˆå‡€åˆ©æ¶¦ï¼‰
        function addFinalRow(tbody, name, amount, totalRevenue, isProfit = false) {
            const row = document.createElement('tr');
            row.className = 'profit-final-row';
            const percentage = totalRevenue > 0 ? (Math.abs(amount) / totalRevenue) * 100 : 0;
            const amountClass = amount >= 0 ? 'positive' : 'negative';
            
            row.innerHTML = `
                <td class="profit-item-name main">${name}</td>
                <td class="profit-amount main ${amountClass}">${amount >= 0 ? '+' : ''}${amount.toFixed(2)}</td>
                <td class="profit-amount main ${amountClass}">${percentage.toFixed(2)}%</td>
            `;
            tbody.appendChild(row);
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateSummary() {
            const calculated = calculateProfitData();
            
            document.getElementById('totalRevenue').textContent = calculated.totalRevenue.toFixed(2);
            document.getElementById('totalCost').textContent = calculated.totalCost.toFixed(2);
            document.getElementById('grossProfit').textContent = calculated.grossProfit.toFixed(2);
            document.getElementById('grossProfitRate').textContent = calculated.grossProfitRate.toFixed(2);
            document.getElementById('operatingExpenses').textContent = calculated.totalExpenses.toFixed(2);
            document.getElementById('operatingProfit').textContent = calculated.operatingProfit.toFixed(2);
            document.getElementById('netProfit').textContent = calculated.netProfit.toFixed(2);
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç»Ÿè®¡å‘¨æœŸå˜åŒ–
            document.getElementById('periodSelect').addEventListener('change', function() {
                const dateRangeFilter = document.getElementById('dateRangeFilter');
                if (this.value === 'custom') {
                    dateRangeFilter.style.display = 'flex';
                } else {
                    dateRangeFilter.style.display = 'none';
                    // æ ¹æ®å‘¨æœŸè®¾ç½®æ—¥æœŸèŒƒå›´
                    const now = new Date();
                    let startDate, endDate;
                    
                    if (this.value === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    } else if (this.value === 'quarter') {
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    } else if (this.value === 'year') {
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                    }
                    
                    if (startDate && endDate) {
                        document.getElementById('dateStart').value = formatDate(startDate);
                        document.getElementById('dateEnd').value = formatDate(endDate);
                    }
                }
            });

            // æŸ¥è¯¢æŒ‰é’®
            document.getElementById('searchBtn').addEventListener('click', function() {
                // è¿™é‡Œå¯ä»¥æ ¹æ®ç­›é€‰æ¡ä»¶é‡æ–°è®¡ç®—æ•°æ®
                renderProfitTable();
                updateSummary();
            });

            // ========== å¯¼å‡ºåŠŸèƒ½ ==========
            document.getElementById('exportBtn').addEventListener('click', () => {
                const calculated = calculateProfitData();
                const headers = ['é¡¹ç›®', 'é‡‘é¢'];
                const rows = [
                    ['è¥ä¸šæ”¶å…¥', calculated.totalRevenue.toFixed(2)],
                    ['è¥ä¸šæˆæœ¬', calculated.totalCost.toFixed(2)],
                    ['æ¯›åˆ©æ¶¦', calculated.grossProfit.toFixed(2)],
                    ['æ¯›åˆ©ç‡', calculated.grossProfitRate.toFixed(2) + '%'],
                    ['è¥ä¸šè´¹ç”¨', calculated.totalExpenses.toFixed(2)],
                    ['è¥ä¸šåˆ©æ¶¦', calculated.operatingProfit.toFixed(2)],
                    ['å‡€åˆ©æ¶¦', calculated.netProfit.toFixed(2)]
                ];
                
                const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'åˆ©æ¶¦è¡¨_' + new Date().toISOString().slice(0, 10) + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // ========== æ‰“å°åŠŸèƒ½ ==========
            document.getElementById('printBtn').addEventListener('click', () => {
                const calculated = calculateProfitData();
                const printWindow = window.open('', '_blank');
                const printContent = `
                    <html>
                        <head>
                            <title>åˆ©æ¶¦è¡¨</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { text-align: center; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                                th { background-color: #f2f2f2; }
                                .text-right { text-align: right; }
                            </style>
                        </head>
                        <body>
                            <h1>åˆ©æ¶¦è¡¨</h1>
                            <p>æ‰“å°æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>é¡¹ç›®</th>
                                        <th class="text-right">é‡‘é¢</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>è¥ä¸šæ”¶å…¥</td>
                                        <td class="text-right">Â¥${calculated.totalRevenue.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>è¥ä¸šæˆæœ¬</td>
                                        <td class="text-right">Â¥${calculated.totalCost.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>æ¯›åˆ©æ¶¦</strong></td>
                                        <td class="text-right"><strong>Â¥${calculated.grossProfit.toFixed(2)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>æ¯›åˆ©ç‡</td>
                                        <td class="text-right">${calculated.grossProfitRate.toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td>è¥ä¸šè´¹ç”¨</td>
                                        <td class="text-right">Â¥${calculated.totalExpenses.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>è¥ä¸šåˆ©æ¶¦</strong></td>
                                        <td class="text-right"><strong>Â¥${calculated.operatingProfit.toFixed(2)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>å‡€åˆ©æ¶¦</strong></td>
                                        <td class="text-right"><strong>Â¥${calculated.netProfit.toFixed(2)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </body>
                    </html>
                `;
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            });

            // ========== åˆ©æ¶¦æ±‡æ€»ç»Ÿè®¡ ==========
            document.getElementById('summaryBtn').addEventListener('click', () => {
                const calculated = calculateProfitData();
                const summaryContent = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">è¥ä¸šæ”¶å…¥</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-primary);">Â¥${calculated.totalRevenue.toFixed(2)}</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">è¥ä¸šæˆæœ¬</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-error);">Â¥${calculated.totalCost.toFixed(2)}</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">æ¯›åˆ©æ¶¦</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-success);">Â¥${calculated.grossProfit.toFixed(2)}</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">æ¯›åˆ©ç‡</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold;">${calculated.grossProfitRate.toFixed(2)}%</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">è¥ä¸šè´¹ç”¨</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-error);">Â¥${calculated.totalExpenses.toFixed(2)}</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">è¥ä¸šåˆ©æ¶¦</div>
                            <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-primary);">Â¥${calculated.operatingProfit.toFixed(2)}</div>
                        </div>
                        <div style="padding: var(--spacing-md); background: var(--color-neutral-50); border-radius: var(--radius-md); grid-column: 1 / -1;">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">å‡€åˆ©æ¶¦</div>
                            <div style="font-size: var(--font-size-2xl); font-weight: bold; color: var(--color-success);">Â¥${calculated.netProfit.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'summaryModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">åˆ©æ¶¦æ±‡æ€»ç»Ÿè®¡</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            ${summaryContent}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.classList.add('show');
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸ
        function setDefaultDates() {
            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('dateStart').value = formatDate(startDate);
            document.getElementById('dateEnd').value = formatDate(endDate);
        }

        // åˆå§‹åŒ–
        setDefaultDates();
        init();
    </script>
</body>
</html>
