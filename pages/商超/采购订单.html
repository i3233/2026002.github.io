<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>采购订单 - 2026新项目二</title>
    <link rel="stylesheet" href="../../css/Main.css">
    <style>
        .purchase-page {
            padding: var(--spacing-lg);
            background-color: var(--color-neutral-50);
        }

        /* 顶部工具栏整体卡片（对齐商品列表头部卡片风格） */
        .toolbar-card {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
        }

        .toolbar-left,
        .toolbar-center,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .toolbar-left {
            flex: 1.6;
            flex-wrap: wrap;
        }

        .toolbar-center {
            flex: 1;
            justify-content: center;
        }

        .toolbar-right {
            flex: 1;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .toolbar-search-input {
            flex: 1;
            min-width: 180px;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-neutral-300);
            font-size: var(--font-size-base);
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .toolbar-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-input-focus);
        }

        .btn-icon-text {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-icon-text-symbol {
            font-size: 14px;
        }

        /* 页面标题条（与其他页统一） */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .page-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* 统计卡片区域 */
        .summary-row {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 220px;
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-md) var(--spacing-lg);
        }

        .summary-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .summary-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: baseline;
            gap: var(--spacing-xs);
        }

        .summary-value-blue {
            color: var(--color-primary);
        }

        .summary-value-red {
            color: var(--color-error);
        }

        .summary-unit {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* 表格容器 */
        .table-container {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--color-neutral-50);
        }

        th, td {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-sm);
            border-bottom: 1px solid var(--color-neutral-200);
            white-space: nowrap;
        }

        th {
            text-align: left;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: var(--spacing-xl);
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: var(--spacing-sm);
            color: var(--color-neutral-400);
            font-size: var(--font-size-xs);
        }

        th.sortable.asc::after {
            content: '↑';
            color: var(--color-primary);
        }

        th.sortable.desc::after {
            content: '↓';
            color: var(--color-primary);
        }

        tbody tr:hover {
            background-color: var(--color-neutral-50);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .checkbox-cell {
            width: 48px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .link-text {
            color: var(--color-primary);
            cursor: pointer;
        }

        .link-text:hover {
            text-decoration: underline;
        }

        .status-pill {
            color: var(--color-primary);
            font-size: var(--font-size-xs);
            cursor: pointer;
        }

        .btn-link {
            color: var(--color-primary);
            background-color: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: var(--font-size-sm);
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .text-right {
            text-align: right;
        }

        .text-secondary {
            color: var(--color-text-secondary);
        }

        /* 合计行 */
        .table-footer-row {
            background-color: var(--color-neutral-50);
            font-weight: var(--font-weight-medium);
        }

        /* 底部工具栏 */
        .bottom-toolbar {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            background-color: #ffffff;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            border-top: 1px solid var(--color-neutral-200);
        }

        .bottom-left,
        .bottom-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .bottom-left label {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* 分页控件 */
        .page-size-select {
            padding: 2px 8px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-neutral-300);
            font-size: var(--font-size-xs);
        }

        .pagination-info {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .pagination-pages {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .pagination-page-btn {
            min-width: 24px;
            padding: 2px 6px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-neutral-300);
            background-color: #ffffff;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .pagination-page-btn.active {
            background-color: var(--color-primary);
            color: #ffffff;
            border-color: var(--color-primary);
        }

        .pagination-page-btn:hover:not(.active) {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .pagination-jump-input {
            width: 40px;
            padding: 2px 4px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-neutral-300);
            font-size: var(--font-size-xs);
            text-align: center;
        }

        /* 新增采购订单弹窗 */
        .purchase-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .purchase-modal-overlay.show { display: flex; }
        .purchase-modal {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 92%;
            max-width: 960px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .purchase-modal .modal-head {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .purchase-modal .modal-head h3 { margin: 0; font-size: var(--font-size-lg); }
        .purchase-modal .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }
        .purchase-modal .modal-foot {
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
        .form-row { display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md); flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 160px; }
        .form-group label { display: block; margin-bottom: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-text-primary); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .form-group .required::after { content: ' *'; color: var(--color-error); }
        .modal-section-title { font-size: var(--font-size-base); font-weight: var(--font-weight-medium); margin: var(--spacing-md) 0 var(--spacing-sm); padding-bottom: var(--spacing-xs); border-bottom: 1px solid var(--color-neutral-200); }
        .purchase-modal .detail-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); }
        .purchase-modal .detail-table th, .purchase-modal .detail-table td { padding: var(--spacing-xs) var(--spacing-sm); border: 1px solid var(--color-neutral-200); text-align: left; }
        .purchase-modal .detail-table th { background: var(--color-neutral-50); font-weight: var(--font-weight-medium); }
        .purchase-modal .detail-table input { width: 100%; padding: 4px 8px; border: 1px solid var(--color-neutral-300); border-radius: 4px; }
        .purchase-modal .detail-table .col-num { width: 60px; text-align: right; }
        .purchase-modal .detail-table .col-price { width: 90px; text-align: right; }
        .purchase-modal .detail-table .col-amount { width: 90px; text-align: right; }
        .purchase-modal .detail-table .col-action { width: 60px; text-align: center; }
        .purchase-modal .detail-total { margin-top: var(--spacing-sm); text-align: right; font-weight: var(--font-weight-medium); }
        .btn-text { background: none; border: none; color: var(--color-primary); cursor: pointer; font-size: var(--font-size-sm); padding: 0 4px; }
        .btn-text:hover { text-decoration: underline; }
        .btn-text.danger { color: var(--color-error); }

        /* 通用弹窗（汇总/详情/更多搜索/属性） */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 92%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { margin: 0; font-size: var(--font-size-lg); }
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--color-text-secondary);
        }
        .modal-close:hover { color: var(--color-text-primary); }
        .modal-body { padding: var(--spacing-lg); overflow-y: auto; flex: 1; }
        .modal-footer {
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* 操作菜单下拉 */
        .action-menu {
            position: fixed;
            background: #fff;
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 1200;
            min-width: 140px;
            display: none;
            overflow: hidden;
        }
        .action-menu.show { display: block; }
        .action-menu-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: var(--font-size-sm);
            white-space: nowrap;
        }
        .action-menu-item:hover { background: var(--color-neutral-50); }
        .action-menu-item.danger { color: var(--color-error); }

        /* 详情区块 */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }
        .detail-item { display: flex; flex-direction: column; gap: var(--spacing-xs); }
        .detail-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .detail-value { font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text-primary); }
        @media (max-width: 900px) {
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .detail-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 1200px) {
            .toolbar-card {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left,
            .toolbar-center,
            .toolbar-right {
                justify-content: flex-start;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-xs);
            }

            .bottom-toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="purchase-page">
        <!-- 页面标题 -->
        <div class="page-header">
            <div>
                <h1 class="page-title">采购订单</h1>
                <div class="page-subtitle">用于管理和追踪进货/采购订单的列表页面。</div>
            </div>
        </div>

        <!-- 顶部工具栏 -->
        <div class="toolbar-card">
            <!-- 左侧按钮组 -->
            <div class="toolbar-left">
                <button class="btn btn-primary" id="addPurchaseOrderBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">＋</span>
                        <span>新增</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="importBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">↓</span>
                        <span>导入</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="exportBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">↑</span>
                        <span>导出</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="exportDetailBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">↑</span>
                        <span>导出详情</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="purchaseVoucherBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">⊕</span>
                        <span>进货单</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="toStorageBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">⊕</span>
                        <span>入库单</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="customAttrBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">≡</span>
                        <span>属性</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="summaryBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">●</span>
                        <span>汇总</span>
                    </span>
                </button>
            </div>

            <!-- 中间搜索区 -->
            <div class="toolbar-center">
                <input type="text" class="toolbar-search-input" id="quickSearchInput" placeholder="快捷搜索：支持按单号、往来单位等关键字">
                <button class="btn btn-primary" id="quickSearchBtn">搜索</button>
            </div>

            <!-- 右侧功能 -->
            <div class="toolbar-right">
                <button class="btn btn-outline" id="moreSearchBtn">更多搜索</button>
                <button class="btn btn-outline" id="statsBtn">
                    <span class="btn-icon-text">
                        <span class="btn-icon-text-symbol">⊙</span>
                        <span>统计</span>
                    </span>
                </button>
                <button class="btn btn-outline" id="listViewBtn" title="切换为列表视图">列表</button>
                <button class="btn btn-outline" id="detailViewBtn" title="切换为详情视图">详情</button>
            </div>
        </div>
        <input type="file" id="importFileInput" accept=".csv" style="display:none;">

        <!-- 统计卡片 -->
        <div class="summary-row">
            <div class="summary-card">
                <div class="summary-label">进货总额 (元)</div>
                <div class="summary-value summary-value-blue">
                    <span>122145.87</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">应付总额 (元) ☆</div>
                <div class="summary-value summary-value-blue">
                    <span>4870.20</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">进货数量</div>
                <div class="summary-value summary-value-red">
                    <span>23809.73</span>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="table-container">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>⊙ 单号</th>
                            <th class="sortable" data-sort="date">日期</th>
                            <th>往来单位</th>
                            <th>项目</th>
                            <th>员工</th>
                            <th>备注</th>
                            <th class="text-right">数量</th>
                            <th class="text-right">进货金额</th>
                            <th class="text-right">应付余额</th>
                            <th>订单状态</th>
                            <th>附件</th>
                            <th>录入员</th>
                            <th>录入时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseTableBody">
                        <!-- JS 渲染 -->
                    </tbody>
                    <tfoot>
                        <tr class="table-footer-row">
                            <td colspan="7" class="text-right">合计：</td>
                            <td class="text-right" id="totalQtyCell">537.20</td>
                            <td class="text-right" id="totalAmountCell">7011.46</td>
                            <td class="text-right" id="totalPayableCell">4357.00</td>
                            <td colspan="5"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- 底部工具栏 -->
            <div class="bottom-toolbar">
                <!-- 左侧批量操作 -->
                <div class="bottom-left">
                    <label>
                        <input type="checkbox" id="bottomSelectAll">
                        <span>全选</span>
                    </label>
                    <button class="btn btn-outline" id="batchFinanceBtn">财务处理</button>
                    <button class="btn btn-outline" id="batchDeleteBtn">删除</button>
                    <span class="text-secondary" id="selectedInfo">已选择 0 条记录</span>
                </div>

                <!-- 右侧分页 -->
                <div class="bottom-right">
                    <select class="page-size-select" id="pageSizeSelect">
                        <option value="20" selected>20 条/页</option>
                        <option value="50">50 条/页</option>
                        <option value="100">100 条/页</option>
                    </select>
                    <span class="pagination-info">共 579 条记录</span>
                    <div class="pagination-pages">
                        <button class="pagination-page-btn" disabled>上一页</button>
                        <button class="pagination-page-btn active">1</button>
                        <button class="pagination-page-btn">2</button>
                        <button class="pagination-page-btn">3</button>
                        <button class="pagination-page-btn">4</button>
                        <span class="pagination-info">...</span>
                        <button class="pagination-page-btn">末页</button>
                        <button class="pagination-page-btn">下一页</button>
                    </div>
                    <span class="pagination-info">跳转到</span>
                    <input type="number" class="pagination-jump-input" min="1" value="1">
                    <span class="pagination-info">页</span>
                </div>
            </div>
        </div>

        <!-- 新增采购订单弹窗 -->
        <div class="purchase-modal-overlay" id="purchaseOrderModalOverlay">
            <div class="purchase-modal">
                <div class="modal-head">
                    <h3>新增采购订单</h3>
                    <button type="button" class="btn btn-outline" id="purchaseOrderModalClose">× 关闭</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">单号</label>
                            <input type="text" id="poOrderId" placeholder="可留空自动生成">
                        </div>
                        <div class="form-group">
                            <label class="required">订单日期</label>
                            <input type="date" id="poDate">
                        </div>
                        <div class="form-group">
                            <label class="required">往来单位</label>
                            <select id="poPartner">
                                <option value="">请选择</option>
                                <option value="雅安本地供应商A">雅安本地供应商A</option>
                                <option value="成都批发商B">成都批发商B</option>
                                <option value="雅安本地供应商C">雅安本地供应商C</option>
                                <option value="茶叶供应商D">茶叶供应商D</option>
                                <option value="天蓝商行">天蓝商行</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>项目</label>
                            <input type="text" id="poProject" placeholder="如：雅安好物进货">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>经手人/员工</label>
                            <select id="poStaff">
                                <option value="">请选择</option>
                                <option value="张三">张三</option>
                                <option value="李四">李四</option>
                                <option value="赵六">赵六</option>
                                <option value="钱七">钱七</option>
                                <option value="王五">王五</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label>备注</label>
                            <textarea id="poRemark" placeholder="选填"></textarea>
                        </div>
                    </div>
                    <div class="modal-section-title">商品明细</div>
                    <div class="table-container">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>商品名称</th>
                                    <th>规格</th>
                                    <th>单位</th>
                                    <th class="col-num">数量</th>
                                    <th class="col-price">单价(元)</th>
                                    <th class="col-amount">金额(元)</th>
                                    <th class="col-action">操作</th>
                                </tr>
                            </thead>
                            <tbody id="poDetailBody"></tbody>
                        </table>
                        <button type="button" class="btn btn-outline" id="poAddRowBtn" style="margin-top: 8px;">+ 添加一行</button>
                        <div class="detail-total">
                            数量合计：<span id="poTotalQty">0</span> &nbsp;&nbsp;
                            进货金额合计：<span id="poTotalAmount">¥0.00</span>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: var(--spacing-md);">
                        <div class="form-group">
                            <label>应付金额(元)</label>
                            <input type="number" id="poPayable" min="0" step="0.01" placeholder="可与进货金额一致或部分付款">
                        </div>
                        <div class="form-group">
                            <label>订单状态</label>
                            <select id="poStatus">
                                <option value="待审核">待审核</option>
                                <option value="已成交">已成交</option>
                                <option value="部分入库">部分入库</option>
                                <option value="已关闭">已关闭</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>附件</label>
                            <input type="text" id="poAttachment" placeholder="如：上传后填写数量或说明">
                        </div>
                    </div>
                </div>
                <div class="modal-foot">
                    <button type="button" class="btn btn-outline" id="purchaseOrderModalCancel">取消</button>
                    <button type="button" class="btn btn-primary" id="purchaseOrderModalSave">保存订单</button>
                </div>
            </div>
        </div>

        <!-- 通用弹窗：汇总/统计 -->
        <div class="modal-overlay" id="summaryModal">
            <div class="modal" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="summaryModalTitle">采购汇总</h3>
                    <button type="button" class="modal-close" id="summaryModalClose">×</button>
                </div>
                <div class="modal-body">
                    <div id="summaryContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="summaryModalCloseBtn">关闭</button>
                </div>
            </div>
        </div>

        <!-- 通用弹窗：订单详情 -->
        <div class="modal-overlay" id="orderDetailModal">
            <div class="modal" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">采购订单详情</h3>
                    <button type="button" class="modal-close" id="orderDetailModalClose">×</button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="orderDetailModalCloseBtn">关闭</button>
                </div>
            </div>
        </div>

        <!-- 通用弹窗：更多搜索 -->
        <div class="modal-overlay" id="moreSearchModal">
            <div class="modal" style="max-width: 760px;">
                <div class="modal-header">
                    <h3 class="modal-title">更多搜索</h3>
                    <button type="button" class="modal-close" id="moreSearchModalClose">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>日期开始</label>
                            <input type="date" id="msDateStart">
                        </div>
                        <div class="form-group">
                            <label>日期结束</label>
                            <input type="date" id="msDateEnd">
                        </div>
                        <div class="form-group">
                            <label>往来单位</label>
                            <input type="text" id="msPartner" placeholder="支持模糊匹配">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>项目</label>
                            <input type="text" id="msProject" placeholder="支持模糊匹配">
                        </div>
                        <div class="form-group">
                            <label>员工</label>
                            <input type="text" id="msStaff" placeholder="支持模糊匹配">
                        </div>
                        <div class="form-group">
                            <label>订单状态</label>
                            <select id="msStatus">
                                <option value="">全部</option>
                                <option value="待审核">待审核</option>
                                <option value="已成交">已成交</option>
                                <option value="部分入库">部分入库</option>
                                <option value="已关闭">已关闭</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="moreSearchResetBtn">重置</button>
                    <button type="button" class="btn btn-primary" id="moreSearchApplyBtn">应用筛选</button>
                </div>
            </div>
        </div>

        <!-- 通用弹窗：属性管理 -->
        <div class="modal-overlay" id="customAttrModal">
            <div class="modal" style="max-width: 760px;">
                <div class="modal-header">
                    <h3 class="modal-title">采购订单属性管理</h3>
                    <button type="button" class="modal-close" id="customAttrModalClose">×</button>
                </div>
                <div class="modal-body">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px; margin-bottom: 12px;">
                        <div class="text-secondary" style="font-size: var(--font-size-sm);">用于模拟“自定义字段/属性”管理体验（前端示例）。</div>
                        <button type="button" class="btn btn-primary" id="addCustomAttrBtn">+ 新增属性</button>
                    </div>
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>属性名</th>
                                        <th>类型</th>
                                        <th>必填</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="customAttrTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="customAttrModalCloseBtn">关闭</button>
                </div>
            </div>
        </div>

        <!-- 操作菜单 -->
        <div class="action-menu" id="actionMenu">
            <div class="action-menu-item" data-action="view">查看详情</div>
            <div class="action-menu-item" data-action="edit">编辑</div>
            <div class="action-menu-item" data-action="audit">审核</div>
            <div class="action-menu-item" data-action="print">打印进货单</div>
            <div class="action-menu-item" data-action="storage">去入库</div>
            <div class="action-menu-item danger" data-action="delete">删除</div>
        </div>
    </div>

    <script>
        // 模拟静态采购订单数据
        const purchases = [
            {
                id: 'JH20250826001',
                date: '2025-08-26',
                partner: '雅安本地供应商A',
                project: '雅安好物进货',
                staff: '张三',
                remark: '首批到货',
                qty: 120.50,
                amount: 1800.20,
                payable: 800.00,
                status: '已成交',
                attachment: '1',
                recorder: '系统管理员',
                recordTime: '2025-08-26 10:25:00'
            },
            {
                id: 'JH20250826002',
                date: '2025-08-26',
                partner: '成都批发商B',
                project: '旅游周边补货',
                staff: '李四',
                remark: '',
                qty: 88.70,
                amount: 1200.00,
                payable: 560.00,
                status: '已成交',
                attachment: '0',
                recorder: '王五',
                recordTime: '2025-08-26 11:10:12'
            },
            {
                id: 'JH20250827001',
                date: '2025-08-27',
                partner: '雅安本地供应商C',
                project: '节庆活动备货',
                staff: '赵六',
                remark: '急单',
                qty: 200.00,
                amount: 2300.50,
                payable: 1500.00,
                status: '已成交',
                attachment: '2',
                recorder: '系统管理员',
                recordTime: '2025-08-27 09:05:30'
            },
            {
                id: 'JH20250828001',
                date: '2025-08-28',
                partner: '茶叶供应商D',
                project: '蒙顶山茶进货',
                staff: '钱七',
                remark: '',
                qty: 128.00,
                amount: 1710.76,
                payable: 1497.00,
                status: '已成交',
                attachment: '0',
                recorder: '王五',
                recordTime: '2025-08-28 14:22:09'
            }
        ];

        let filteredPurchases = [...purchases];
        let sortColumn = null;
        let sortDirection = 'asc';
        let viewMode = 'list'; // list | detail（当前仅用于切换按钮状态）

        // 明细数据（用于详情/导出详情/打印进货单）
        const purchaseDetailsMap = {
            'JH20250826001': [
                { name: '蒙顶山茶叶', spec: '500g/盒', unit: '盒', qty: 20, price: 45.00 },
                { name: '雅安花椒', spec: '250g/袋', unit: '袋', qty: 30, price: 28.00 }
            ],
            'JH20250826002': [
                { name: '熊猫玩偶', spec: '20cm', unit: '个', qty: 50, price: 15.00 },
                { name: '雅安明信片', spec: '一套10张', unit: '套', qty: 30, price: 12.00 }
            ],
            'JH20250827001': [
                { name: '雅安特产礼盒', spec: '1kg装', unit: '盒', qty: 25, price: 88.00 },
                { name: '雅安蜂蜜', spec: '500g/瓶', unit: '瓶', qty: 40, price: 35.00 }
            ],
            'JH20250828001': [
                { name: '蒙顶山茶', spec: '250g/盒', unit: '盒', qty: 18, price: 58.00 },
                { name: '雅安菌菇干货', spec: '200g/袋', unit: '袋', qty: 20, price: 35.54 }
            ]
        };

        function getDetailsById(id) {
            return purchaseDetailsMap[id] || [];
        }

        const tbody = document.getElementById('purchaseTableBody');

        function renderTable() {
            tbody.innerHTML = '';
            filteredPurchases.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" data-id="${item.id}">
                    </td>
                    <td>
                        <span class="link-text order-link" data-id="${item.id}">${item.id}</span>
                    </td>
                    <td>${item.date}</td>
                    <td>${item.partner}</td>
                    <td>${item.project}</td>
                    <td>${item.staff}</td>
                    <td>${item.remark || '-'}</td>
                    <td class="text-right">${item.qty.toFixed(2)}</td>
                    <td class="text-right">${item.amount.toFixed(2)}</td>
                    <td class="text-right">${item.payable.toFixed(2)}</td>
                    <td>
                        <span class="status-pill status-link" data-id="${item.id}">${item.status}</span>
                    </td>
                    <td>${item.attachment === '0' ? '-' : item.attachment + ' 个'}</td>
                    <td>${item.recorder}</td>
                    <td>${item.recordTime}</td>
                    <td>
                        <button class="btn-link view-btn" data-id="${item.id}">操作</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateSelectedInfo();
        }

        // 简单的日期排序
        function sortData(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            if (column === 'date') {
                filteredPurchases.sort((a, b) => {
                    if (sortDirection === 'asc') {
                        return a.date > b.date ? 1 : -1;
                    } else {
                        return a.date < b.date ? 1 : -1;
                    }
                });
            }

            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            const th = document.querySelector('th.sortable[data-sort="' + column + '"]');
            if (th) {
                th.classList.add(sortDirection);
            }

            renderTable();
        }

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.sort;
                sortData(col);
            });
        });

        // 快捷搜索（仅前端模糊过滤示意）
        function doQuickSearch() {
            const kw = document.getElementById('quickSearchInput').value.trim().toLowerCase();
            if (!kw) {
                filteredPurchases = [...purchases];
            } else {
                filteredPurchases = purchases.filter(p => {
                    return (
                        p.id.toLowerCase().includes(kw) ||
                        p.partner.toLowerCase().includes(kw) ||
                        p.project.toLowerCase().includes(kw) ||
                        p.staff.toLowerCase().includes(kw)
                    );
                });
            }
            renderTable();
        }

        document.getElementById('quickSearchBtn').addEventListener('click', doQuickSearch);
        document.getElementById('quickSearchInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                doQuickSearch();
            }
        });

        // 全选 / 反选
        const selectAll = document.getElementById('selectAll');
        const bottomSelectAll = document.getElementById('bottomSelectAll');

        function syncSelectAll() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            const allChecked = checkedCount > 0 && checkedCount === checkboxes.length;
            selectAll.checked = allChecked;
            bottomSelectAll.checked = allChecked;
            updateSelectedInfo();
        }

        selectAll.addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => (cb.checked = checked));
            bottomSelectAll.checked = checked;
            updateSelectedInfo();
        });

        bottomSelectAll.addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => (cb.checked = checked));
            selectAll.checked = checked;
            updateSelectedInfo();
        });

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('row-checkbox')) {
                syncSelectAll();
            }
        });

        function getSelectedIds() {
            const ids = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                ids.push(cb.dataset.id);
            });
            return ids;
        }

        function updateSelectedInfo() {
            const ids = getSelectedIds();
            document.getElementById('selectedInfo').textContent = '已选择 ' + ids.length + ' 条记录';
        }

        // 底部批量操作（仅示意）
        document.getElementById('batchFinanceBtn').addEventListener('click', function () {
            const ids = getSelectedIds();
            if (!ids.length) {
                alert('请先勾选需要处理的采购订单。');
                return;
            }
            const selected = purchases.filter(p => ids.includes(p.id));
            const totalPayable = selected.reduce((sum, p) => sum + (Number(p.payable) || 0), 0);
            if (totalPayable <= 0) {
                alert('所选订单应付余额为 0，无需财务处理。');
                return;
            }
            const pay = prompt(
                `本次付款（合计）金额（元）：\\n应付余额合计：${totalPayable.toFixed(2)}\\n\\n输入金额后将按比例分摊到每条订单（前端示例）。`,
                totalPayable.toFixed(2)
            );
            if (pay === null) return;
            const payAmount = Number(pay);
            if (!Number.isFinite(payAmount) || payAmount <= 0) {
                alert('请输入有效的付款金额。');
                return;
            }
            const actualPay = Math.min(payAmount, totalPayable);
            selected.forEach(p => {
                const ratio = (Number(p.payable) || 0) / totalPayable;
                const allocated = actualPay * ratio;
                p.payable = Math.max(0, (Number(p.payable) || 0) - allocated);
                if (p.payable === 0 && p.status === '待审核') p.status = '已成交';
            });
            filteredPurchases = [...purchases];
            renderTable();
            alert(`财务处理完成：本次付款 ¥${actualPay.toFixed(2)}（按比例分摊）。`);
        });

        document.getElementById('batchDeleteBtn').addEventListener('click', function () {
            const ids = getSelectedIds();
            if (!ids.length) {
                alert('请先勾选需要删除的采购订单。');
                return;
            }
            if (!confirm('确定要删除选中的订单吗？')) {
                return;
            }
            ids.forEach(id => {
                const idx = purchases.findIndex(p => p.id === id);
                if (idx > -1) purchases.splice(idx, 1);
                delete purchaseDetailsMap[id];
            });
            filteredPurchases = [...purchases];
            renderTable();
            alert('已删除 ' + ids.length + ' 条记录。');
        });

        // ========= 工具：CSV =========
        function escapeCsvCell(v) {
            const s = String(v ?? '');
            if (/[\",\\n]/.test(s)) return `"${s.replace(/\"/g, '\"\"')}"`;
            return s;
        }
        function downloadCsv(filename, csvText) {
            const blob = new Blob(['\\ufeff' + csvText], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ========= 弹窗：订单详情 =========
        const orderDetailModal = document.getElementById('orderDetailModal');
        function openOrderDetail(id) {
            const item = purchases.find(p => p.id === id);
            if (!item) return;
            const details = getDetailsById(id);
            const detailRowsHtml = details.length
                ? details.map((d, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${d.name}</td>
                        <td>${d.spec || '-'}</td>
                        <td>${d.unit || '-'}</td>
                        <td class="text-right">${Number(d.qty || 0).toFixed(2)}</td>
                        <td class="text-right">${Number(d.price || 0).toFixed(2)}</td>
                        <td class="text-right">${(Number(d.qty || 0) * Number(d.price || 0)).toFixed(2)}</td>
                    </tr>
                `).join('')
                : `<tr><td colspan="7" class="text-secondary">暂无明细（示例数据未录入）</td></tr>`;

            document.getElementById('orderDetailContent').innerHTML = `
                <div class="detail-grid" style="margin-bottom: 16px;">
                    <div class="detail-item"><div class="detail-label">单号</div><div class="detail-value">${item.id}</div></div>
                    <div class="detail-item"><div class="detail-label">日期</div><div class="detail-value">${item.date}</div></div>
                    <div class="detail-item"><div class="detail-label">往来单位</div><div class="detail-value">${item.partner}</div></div>
                    <div class="detail-item"><div class="detail-label">项目</div><div class="detail-value">${item.project || '-'}</div></div>
                    <div class="detail-item"><div class="detail-label">员工</div><div class="detail-value">${item.staff || '-'}</div></div>
                    <div class="detail-item"><div class="detail-label">订单状态</div><div class="detail-value">${item.status}</div></div>
                    <div class="detail-item"><div class="detail-label">数量</div><div class="detail-value">${item.qty.toFixed(2)}</div></div>
                    <div class="detail-item"><div class="detail-label">进货金额</div><div class="detail-value">¥${item.amount.toFixed(2)}</div></div>
                    <div class="detail-item"><div class="detail-label">应付余额</div><div class="detail-value">¥${item.payable.toFixed(2)}</div></div>
                </div>
                <div class="modal-section-title">商品明细</div>
                <div class="table-container">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>商品名称</th>
                                    <th>规格</th>
                                    <th>单位</th>
                                    <th class="text-right">数量</th>
                                    <th class="text-right">单价</th>
                                    <th class="text-right">金额</th>
                                </tr>
                            </thead>
                            <tbody>${detailRowsHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
            orderDetailModal.classList.add('show');
        }
        function closeOrderDetail() { orderDetailModal.classList.remove('show'); }
        document.getElementById('orderDetailModalClose').addEventListener('click', closeOrderDetail);
        document.getElementById('orderDetailModalCloseBtn').addEventListener('click', closeOrderDetail);
        orderDetailModal.addEventListener('click', (e) => { if (e.target === orderDetailModal) closeOrderDetail(); });

        // ========= 弹窗：汇总 / 统计 =========
        const summaryModal = document.getElementById('summaryModal');
        function openSummary(type) {
            const data = filteredPurchases;
            const totalAmount = data.reduce((s, x) => s + (Number(x.amount) || 0), 0);
            const totalPayable = data.reduce((s, x) => s + (Number(x.payable) || 0), 0);
            const totalQty = data.reduce((s, x) => s + (Number(x.qty) || 0), 0);
            const byPartner = {};
            const byStatus = {};
            data.forEach(x => {
                const p = x.partner || '未知';
                const st = x.status || '未知';
                byPartner[p] = byPartner[p] || { count: 0, amount: 0 };
                byStatus[st] = byStatus[st] || { count: 0, amount: 0 };
                byPartner[p].count += 1;
                byPartner[p].amount += (Number(x.amount) || 0);
                byStatus[st].count += 1;
                byStatus[st].amount += (Number(x.amount) || 0);
            });

            document.getElementById('summaryModalTitle').textContent = type === 'stats' ? '采购统计' : '采购汇总';
            document.getElementById('summaryContent').innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="padding: 12px; background: var(--color-neutral-50); border-radius: var(--radius-md);">
                        <div class="text-secondary" style="font-size: var(--font-size-sm);">进货总额</div>
                        <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-primary);">¥${totalAmount.toFixed(2)}</div>
                    </div>
                    <div style="padding: 12px; background: var(--color-neutral-50); border-radius: var(--radius-md);">
                        <div class="text-secondary" style="font-size: var(--font-size-sm);">应付余额合计</div>
                        <div style="font-size: var(--font-size-xl); font-weight: bold; color: var(--color-error);">¥${totalPayable.toFixed(2)}</div>
                    </div>
                    <div style="padding: 12px; background: var(--color-neutral-50); border-radius: var(--radius-md);">
                        <div class="text-secondary" style="font-size: var(--font-size-sm);">进货数量</div>
                        <div style="font-size: var(--font-size-xl); font-weight: bold;">${totalQty.toFixed(2)}</div>
                    </div>
                </div>
                <div class="modal-section-title">按往来单位</div>
                <div class="table-container"><div class="table-wrapper">
                    <table>
                        <thead><tr><th>往来单位</th><th class="text-right">订单数</th><th class="text-right">金额</th></tr></thead>
                        <tbody>
                            ${Object.entries(byPartner).map(([k,v]) => `<tr><td>${k}</td><td class="text-right">${v.count}</td><td class="text-right">¥${v.amount.toFixed(2)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div></div>
                <div class="modal-section-title" style="margin-top:16px;">按状态</div>
                <div class="table-container"><div class="table-wrapper">
                    <table>
                        <thead><tr><th>状态</th><th class="text-right">订单数</th><th class="text-right">金额</th></tr></thead>
                        <tbody>
                            ${Object.entries(byStatus).map(([k,v]) => `<tr><td>${k}</td><td class="text-right">${v.count}</td><td class="text-right">¥${v.amount.toFixed(2)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div></div>
            `;
            summaryModal.classList.add('show');
        }
        function closeSummary() { summaryModal.classList.remove('show'); }
        document.getElementById('summaryModalClose').addEventListener('click', closeSummary);
        document.getElementById('summaryModalCloseBtn').addEventListener('click', closeSummary);
        summaryModal.addEventListener('click', (e) => { if (e.target === summaryModal) closeSummary(); });

        // ========= 操作菜单 =========
        const actionMenu = document.getElementById('actionMenu');
        let currentActionId = null;
        function openActionMenu(id, anchorEl) {
            currentActionId = id;
            const rect = anchorEl.getBoundingClientRect();
            actionMenu.style.left = rect.left + 'px';
            actionMenu.style.top = (rect.bottom + 6) + 'px';
            actionMenu.classList.add('show');
        }
        function hideActionMenu() {
            actionMenu.classList.remove('show');
        }
        function gotoStorage(orderId) {
            window.open(`采购入库.html?orderId=${encodeURIComponent(orderId)}`, '_blank');
        }
        function auditOrder(id) {
            const item = purchases.find(p => p.id === id);
            if (!item) return;
            const choice = prompt(`审核采购订单：${id}\\n1. 通过\\n2. 退回（待审核）\\n3. 关闭\\n\\n请输入序号：`, '1');
            if (choice === null) return;
            if (choice === '1') item.status = '已成交';
            if (choice === '2') item.status = '待审核';
            if (choice === '3') item.status = '已关闭';
            renderTable();
        }
        function deleteOrders(ids) {
            if (!ids.length) return;
            if (!confirm('确定删除所选订单吗？')) return;
            ids.forEach(id => {
                const idx = purchases.findIndex(p => p.id === id);
                if (idx > -1) purchases.splice(idx, 1);
                delete purchaseDetailsMap[id];
            });
            filteredPurchases = [...purchases];
            renderTable();
        }
        function printVouchers(ids) {
            const list = purchases.filter(p => ids.includes(p.id));
            if (!list.length) { alert('没有可打印的数据'); return; }
            const win = window.open('', '_blank');
            const html = `
                <html><head><title>进货单</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    .voucher { border: 2px solid #000; padding: 16px; margin-bottom: 24px; page-break-after: always; }
                    .voucher h2 { margin: 0 0 8px; text-align: center; }
                    .meta { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-bottom: 12px; }
                    table { width: 100%; border-collapse: collapse; font-size: 12px; }
                    th, td { border: 1px solid #ddd; padding: 6px; }
                    th { background: #f2f2f2; }
                    .right { text-align: right; }
                </style></head><body>
                ${list.map(p => {
                    const details = getDetailsById(p.id);
                    const bodyRows = details.length ? details.map((d,i)=>`
                        <tr>
                            <td>${i+1}</td><td>${d.name}</td><td>${d.spec||'-'}</td><td>${d.unit||'-'}</td>
                            <td class="right">${Number(d.qty||0).toFixed(2)}</td>
                            <td class="right">${Number(d.price||0).toFixed(2)}</td>
                            <td class="right">${(Number(d.qty||0)*Number(d.price||0)).toFixed(2)}</td>
                        </tr>
                    `).join('') : `<tr><td colspan="7">暂无明细</td></tr>`;
                    return `
                        <div class="voucher">
                            <h2>进货单</h2>
                            <div class="meta">
                                <div>单号：${p.id}</div>
                                <div>日期：${p.date}</div>
                                <div>往来单位：${p.partner}</div>
                                <div>项目：${p.project||'-'}</div>
                                <div>员工：${p.staff||'-'}</div>
                                <div>状态：${p.status}</div>
                            </div>
                            <table>
                                <thead><tr><th>序号</th><th>商品</th><th>规格</th><th>单位</th><th class="right">数量</th><th class="right">单价</th><th class="right">金额</th></tr></thead>
                                <tbody>${bodyRows}</tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="right"><strong>合计</strong></td>
                                        <td class="right"><strong>${p.qty.toFixed(2)}</strong></td>
                                        <td></td>
                                        <td class="right"><strong>${p.amount.toFixed(2)}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                            ${p.remark ? `<div style="margin-top:10px; font-size:12px;"><strong>备注：</strong>${p.remark}</div>` : ''}
                        </div>
                    `;
                }).join('')}
                </body></html>
            `;
            win.document.write(html);
            win.document.close();
            win.print();
        }
        actionMenu.addEventListener('click', function (e) {
            const item = e.target.closest('.action-menu-item');
            if (!item) return;
            const id = currentActionId;
            const action = item.dataset.action;
            hideActionMenu();
            if (!id) return;
            if (action === 'view') openOrderDetail(id);
            if (action === 'audit') auditOrder(id);
            if (action === 'print') printVouchers([id]);
            if (action === 'storage') gotoStorage(id);
            if (action === 'delete') deleteOrders([id]);
            if (action === 'edit') alert('编辑（示例）：可复用“新增采购订单”弹窗实现编辑。');
        });

        // ========= 更多搜索 =========
        const moreSearchModal = document.getElementById('moreSearchModal');
        function openMoreSearch() { moreSearchModal.classList.add('show'); }
        function closeMoreSearch() { moreSearchModal.classList.remove('show'); }
        document.getElementById('moreSearchBtn').addEventListener('click', openMoreSearch);
        document.getElementById('moreSearchModalClose').addEventListener('click', closeMoreSearch);
        moreSearchModal.addEventListener('click', (e) => { if (e.target === moreSearchModal) closeMoreSearch(); });
        document.getElementById('moreSearchResetBtn').addEventListener('click', () => {
            ['msDateStart','msDateEnd','msPartner','msProject','msStaff'].forEach(id => (document.getElementById(id).value = ''));
            document.getElementById('msStatus').value = '';
        });
        document.getElementById('moreSearchApplyBtn').addEventListener('click', () => {
            const ds = document.getElementById('msDateStart').value;
            const de = document.getElementById('msDateEnd').value;
            const partner = document.getElementById('msPartner').value.trim().toLowerCase();
            const project = document.getElementById('msProject').value.trim().toLowerCase();
            const staff = document.getElementById('msStaff').value.trim().toLowerCase();
            const status = document.getElementById('msStatus').value;
            filteredPurchases = purchases.filter(p => {
                if (ds && p.date < ds) return false;
                if (de && p.date > de) return false;
                if (partner && !(p.partner || '').toLowerCase().includes(partner)) return false;
                if (project && !(p.project || '').toLowerCase().includes(project)) return false;
                if (staff && !(p.staff || '').toLowerCase().includes(staff)) return false;
                if (status && p.status !== status) return false;
                return true;
            });
            renderTable();
            closeMoreSearch();
        });

        // ========= 属性管理 =========
        const customAttrModal = document.getElementById('customAttrModal');
        const customAttrs = [
            { name: '送货方式', type: '文本', required: false },
            { name: '发票类型', type: '下拉', required: false }
        ];
        function renderCustomAttrTable() {
            const body = document.getElementById('customAttrTableBody');
            body.innerHTML = '';
            customAttrs.forEach((a, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${a.name}</td>
                    <td>${a.type}</td>
                    <td>${a.required ? '是' : '否'}</td>
                    <td>
                        <button class="btn-link" data-act="editAttr" data-idx="${i}">编辑</button>
                        <button class="btn-link" data-act="delAttr" data-idx="${i}" style="color: var(--color-error); margin-left: 8px;">删除</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }
        function openCustomAttr() { renderCustomAttrTable(); customAttrModal.classList.add('show'); }
        function closeCustomAttr() { customAttrModal.classList.remove('show'); }
        document.getElementById('customAttrBtn').addEventListener('click', openCustomAttr);
        document.getElementById('customAttrModalClose').addEventListener('click', closeCustomAttr);
        document.getElementById('customAttrModalCloseBtn').addEventListener('click', closeCustomAttr);
        customAttrModal.addEventListener('click', (e) => { if (e.target === customAttrModal) closeCustomAttr(); });
        document.getElementById('addCustomAttrBtn').addEventListener('click', () => {
            const name = prompt('属性名：');
            if (!name) return;
            const type = prompt('类型（文本/数字/下拉）：', '文本') || '文本';
            const required = confirm('是否必填？');
            customAttrs.push({ name: name.trim(), type: type.trim(), required });
            renderCustomAttrTable();
        });
        document.getElementById('customAttrTableBody').addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-act]');
            if (!btn) return;
            const idx = Number(btn.dataset.idx);
            if (!Number.isFinite(idx) || !customAttrs[idx]) return;
            if (btn.dataset.act === 'delAttr') {
                if (confirm('确定删除该属性吗？')) {
                    customAttrs.splice(idx, 1);
                    renderCustomAttrTable();
                }
            }
            if (btn.dataset.act === 'editAttr') {
                const a = customAttrs[idx];
                const name = prompt('属性名：', a.name);
                if (!name) return;
                const type = prompt('类型：', a.type) || a.type;
                const required = confirm('是否必填？');
                customAttrs[idx] = { name: name.trim(), type: type.trim(), required };
                renderCustomAttrTable();
            }
        });

        // ========= 导出/导出详情/导入 =========
        document.getElementById('exportBtn').addEventListener('click', function () {
            const data = filteredPurchases;
            if (!data.length) { alert('没有数据可导出'); return; }
            const headers = ['单号','日期','往来单位','项目','员工','备注','数量','进货金额','应付余额','订单状态','附件','录入员','录入时间'];
            const rows = data.map(x => [
                x.id, x.date, x.partner, x.project, x.staff, x.remark || '',
                x.qty.toFixed(2), x.amount.toFixed(2), x.payable.toFixed(2),
                x.status, x.attachment, x.recorder, x.recordTime
            ].map(escapeCsvCell).join(','));
            downloadCsv(`采购订单_${new Date().toISOString().slice(0,10)}.csv`, [headers.join(','), ...rows].join('\\n'));
        });
        document.getElementById('exportDetailBtn').addEventListener('click', function () {
            const data = filteredPurchases;
            if (!data.length) { alert('没有数据可导出'); return; }
            const headers = ['单号','日期','往来单位','项目','员工','订单状态','商品名称','规格','单位','数量','单价','金额'];
            const rows = [];
            data.forEach(x => {
                const ds = getDetailsById(x.id);
                if (!ds.length) {
                    rows.push([x.id,x.date,x.partner,x.project,x.staff,x.status,'','','','0','0','0'].map(escapeCsvCell).join(','));
                } else {
                    ds.forEach(d => {
                        rows.push([
                            x.id,x.date,x.partner,x.project,x.staff,x.status,
                            d.name, d.spec || '', d.unit || '',
                            Number(d.qty||0).toFixed(2),
                            Number(d.price||0).toFixed(2),
                            (Number(d.qty||0)*Number(d.price||0)).toFixed(2)
                        ].map(escapeCsvCell).join(','));
                    });
                }
            });
            downloadCsv(`采购订单_详情_${new Date().toISOString().slice(0,10)}.csv`, [headers.join(','), ...rows].join('\\n'));
        });
        document.getElementById('importBtn').addEventListener('click', function () {
            document.getElementById('importFileInput').value = '';
            document.getElementById('importFileInput').click();
        });
        document.getElementById('importFileInput').addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const text = String(reader.result || '');
                    const lines = text.split(/\\r?\\n/).filter(l => l.trim());
                    if (lines.length < 2) { alert('CSV 内容为空或格式不正确'); return; }
                    const header = lines[0].split(',').map(s => s.trim());
                    const idx = (name) => header.indexOf(name);
                    const idIdx = idx('单号');
                    const dateIdx = idx('日期');
                    const partnerIdx = idx('往来单位');
                    if (idIdx === -1 || dateIdx === -1 || partnerIdx === -1) {
                        alert('导入失败：请确保包含表头：单号、日期、往来单位（其余可选）。');
                        return;
                    }
                    let added = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        const id = (cols[idIdx] || '').trim();
                        const date = (cols[dateIdx] || '').trim();
                        const partner = (cols[partnerIdx] || '').trim();
                        if (!id || !date || !partner) continue;
                        if (purchases.some(p => p.id === id)) continue;
                        purchases.unshift({
                            id,
                            date,
                            partner,
                            project: '',
                            staff: '',
                            remark: '',
                            qty: 0,
                            amount: 0,
                            payable: 0,
                            status: '待审核',
                            attachment: '0',
                            recorder: '导入',
                            recordTime: new Date().toLocaleString('zh-CN')
                        });
                        added++;
                    }
                    filteredPurchases = [...purchases];
                    renderTable();
                    alert(`导入完成：新增 ${added} 条。`);
                } catch (err) {
                    console.error(err);
                    alert('导入失败：解析 CSV 出错。');
                }
            };
            reader.readAsText(file, 'utf-8');
        });

        // ========= 工具栏：汇总/统计/进货单/入库单/视图 =========
        document.getElementById('summaryBtn').addEventListener('click', () => openSummary('summary'));
        document.getElementById('statsBtn').addEventListener('click', () => openSummary('stats'));
        document.getElementById('purchaseVoucherBtn').addEventListener('click', () => {
            const ids = getSelectedIds();
            if (!ids.length) { alert('请先勾选需要打印的订单'); return; }
            printVouchers(ids);
        });
        document.getElementById('toStorageBtn').addEventListener('click', () => {
            const ids = getSelectedIds();
            if (!ids.length) { alert('请先勾选需要入库的采购订单'); return; }
            if (ids.length === 1) { gotoStorage(ids[0]); return; }
            const choose = prompt('已选择多条订单，请输入要入库的单号：\\n' + ids.join('\\n'), ids[0]);
            if (choose && ids.includes(choose.trim())) gotoStorage(choose.trim());
        });
        document.getElementById('listViewBtn').addEventListener('click', () => { viewMode = 'list'; renderTable(); });
        document.getElementById('detailViewBtn').addEventListener('click', () => { viewMode = 'detail'; renderTable(); });

        // ========= 可点击元素：单号、状态、操作 =========
        document.addEventListener('click', function (e) {
            const orderLink = e.target.closest('.order-link');
            const statusLink = e.target.closest('.status-link');
            const viewBtn = e.target.closest('.view-btn');
            if (orderLink) {
                openOrderDetail(orderLink.dataset.id);
            }
            if (statusLink) {
                auditOrder(statusLink.dataset.id);
            }
            if (viewBtn) {
                e.stopPropagation();
                openActionMenu(viewBtn.dataset.id, viewBtn);
            } else {
                hideActionMenu();
            }
        });

        // ========== 新增采购订单弹窗 ==========
        const purchaseOrderModal = document.getElementById('purchaseOrderModalOverlay');
        const poDetailBody = document.getElementById('poDetailBody');
        const defaultProducts = [
            '蒙顶山茶', '雅安花椒油', '雅安蜂蜜', '雅安菌菇干货', '熊猫周边玩偶', '精品礼盒装', '雅安特产绿营养蛋', '腊味礼盒', '雅鱼鲜礼盒'
        ];

        function openPurchaseOrderModal() {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('poOrderId').value = '';
            document.getElementById('poDate').value = today;
            document.getElementById('poPartner').value = '';
            document.getElementById('poProject').value = '';
            document.getElementById('poStaff').value = '';
            document.getElementById('poRemark').value = '';
            document.getElementById('poPayable').value = '';
            document.getElementById('poStatus').value = '待审核';
            document.getElementById('poAttachment').value = '';
            poDetailBody.innerHTML = '';
            addPoDetailRow();
            addPoDetailRow();
            updatePoTotals();
            purchaseOrderModal.classList.add('show');
        }

        function closePurchaseOrderModal() {
            purchaseOrderModal.classList.remove('show');
        }

        function addPoDetailRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="po-name" placeholder="商品名称" list="poProductList"></td>
                <td><input type="text" class="po-spec" placeholder="规格"></td>
                <td>
                    <select class="po-unit">
                        <option value="个">个</option>
                        <option value="盒">盒</option>
                        <option value="袋">袋</option>
                        <option value="瓶">瓶</option>
                        <option value="包">包</option>
                        <option value="套">套</option>
                        <option value="斤">斤</option>
                        <option value="kg">kg</option>
                    </select>
                </td>
                <td><input type="number" class="po-qty col-num" min="0" step="0.01" value="0"></td>
                <td><input type="number" class="po-price col-price" min="0" step="0.01" value="0"></td>
                <td class="col-amount po-amount">0.00</td>
                <td class="col-action"><button type="button" class="btn-text danger po-remove-row">删除</button></td>
            `;
            poDetailBody.appendChild(tr);
            tr.querySelector('.po-qty').addEventListener('input', updatePoRowAmount);
            tr.querySelector('.po-price').addEventListener('input', updatePoRowAmount);
            tr.querySelector('.po-remove-row').addEventListener('click', function () {
                if (poDetailBody.querySelectorAll('tr').length <= 1) return;
                tr.remove();
                updatePoTotals();
            });
            updatePoTotals();
        }

        function updatePoRowAmount(e) {
            const row = e.target.closest('tr');
            const qty = parseFloat(row.querySelector('.po-qty').value) || 0;
            const price = parseFloat(row.querySelector('.po-price').value) || 0;
            row.querySelector('.po-amount').textContent = (qty * price).toFixed(2);
            updatePoTotals();
        }

        function updatePoTotals() {
            let totalQty = 0, totalAmount = 0;
            poDetailBody.querySelectorAll('tr').forEach(tr => {
                const qty = parseFloat(tr.querySelector('.po-qty').value) || 0;
                const price = parseFloat(tr.querySelector('.po-price').value) || 0;
                totalQty += qty;
                totalAmount += qty * price;
            });
            document.getElementById('poTotalQty').textContent = totalQty.toFixed(2);
            document.getElementById('poTotalAmount').textContent = '¥' + totalAmount.toFixed(2);
            const payInput = document.getElementById('poPayable');
            if (payInput && !payInput.value) payInput.placeholder = totalAmount.toFixed(2);
        }

        document.getElementById('addPurchaseOrderBtn').addEventListener('click', openPurchaseOrderModal);
        document.getElementById('purchaseOrderModalClose').addEventListener('click', closePurchaseOrderModal);
        document.getElementById('purchaseOrderModalCancel').addEventListener('click', closePurchaseOrderModal);
        purchaseOrderModal.addEventListener('click', function (e) {
            if (e.target === purchaseOrderModal) closePurchaseOrderModal();
        });
        document.getElementById('poAddRowBtn').addEventListener('click', addPoDetailRow);

        document.getElementById('poDetailBody').addEventListener('input', function (e) {
            if (e.target.classList.contains('po-qty') || e.target.classList.contains('po-price')) {
                updatePoRowAmount(e);
            }
        });

        document.getElementById('purchaseOrderModalSave').addEventListener('click', function () {
            const orderId = document.getElementById('poOrderId').value.trim();
            const date = document.getElementById('poDate').value;
            const partner = document.getElementById('poPartner').value;
            if (!date) { alert('请选择订单日期'); return; }
            if (!partner) { alert('请选择往来单位'); return; }
            let totalQty = 0, totalAmount = 0;
            const rows = [];
            poDetailBody.querySelectorAll('tr').forEach(tr => {
                const name = tr.querySelector('.po-name').value.trim();
                const spec = tr.querySelector('.po-spec').value.trim();
                const unit = tr.querySelector('.po-unit').value;
                const qty = parseFloat(tr.querySelector('.po-qty').value) || 0;
                const price = parseFloat(tr.querySelector('.po-price').value) || 0;
                if (name && (qty > 0 || price > 0)) {
                    totalQty += qty;
                    totalAmount += qty * price;
                    rows.push({ name, spec, unit, qty, price });
                }
            });
            if (totalQty <= 0 && totalAmount <= 0) {
                alert('请至少添加一行有效商品明细（数量或金额大于0）。');
                return;
            }
            const payable = parseFloat(document.getElementById('poPayable').value) || totalAmount;
            const newId = orderId || ('JH' + date.replace(/-/g, '') + String(purchases.length + 1).padStart(3, '0'));
            const now = new Date();
            const recordTime = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
            purchases.unshift({
                id: newId,
                date: date,
                partner: partner,
                project: document.getElementById('poProject').value.trim() || '-',
                staff: document.getElementById('poStaff').value || '',
                remark: document.getElementById('poRemark').value.trim() || '',
                qty: totalQty,
                amount: totalAmount,
                payable: payable,
                status: document.getElementById('poStatus').value,
                attachment: document.getElementById('poAttachment').value.trim() || '0',
                recorder: '系统管理员',
                recordTime: recordTime
            });
            purchaseDetailsMap[newId] = rows;
            filteredPurchases = [...purchases];
            renderTable();
            closePurchaseOrderModal();
        });

        var poDatalist = document.createElement('datalist');
        poDatalist.id = 'poProductList';
        defaultProducts.forEach(function (p) { var o = document.createElement('option'); o.value = p; poDatalist.appendChild(o); });
        document.body.appendChild(poDatalist);

        // 初始化渲染
        renderTable();
    </script>
</body>
</html>
