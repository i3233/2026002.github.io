<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>采购入库 - 2026新项目二</title>
    <link rel="stylesheet" href="../../css/Main.css">
    <style>
        .purchase-storage-page {
            padding: var(--spacing-lg);
            background-color: var(--color-neutral-50);
        }

        /* 页面标题 */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .page-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* 订单选择区域 */
        .order-select-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .order-select-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .order-select-label {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            white-space: nowrap;
        }

        .order-select-wrapper {
            flex: 1;
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .order-select-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .order-select-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-input-focus);
        }

        /* 订单信息卡片 */
        .order-info-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: var(--color-neutral-50);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .order-info-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .order-info-value {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        /* 商品明细表格 */
        .products-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--color-neutral-50);
        }

        th, td {
            padding: var(--spacing-md);
            text-align: left;
            font-size: var(--font-size-sm);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        th {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            white-space: nowrap;
        }

        tbody tr:hover {
            background-color: var(--color-neutral-50);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .barcode-input {
            width: 100%;
            min-width: 150px;
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-family: var(--font-family-mono);
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .barcode-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-input-focus);
        }

        .barcode-input.required {
            border-color: var(--color-error);
        }

        .barcode-input.required:focus {
            border-color: var(--color-error);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .barcode-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-xs);
        }

        .barcode-status.matched {
            color: var(--color-success);
        }

        .barcode-status.unmatched {
            color: var(--color-error);
        }

        .text-right {
            text-align: right;
        }

        /* 条码扫描区域 */
        .barcode-scan-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .barcode-scan-box {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            padding: var(--spacing-md);
            background-color: var(--color-neutral-50);
            border-radius: var(--radius-md);
            border: 2px dashed var(--color-neutral-300);
        }

        .barcode-scan-input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: var(--font-family-mono);
            transition: all var(--transition-base) var(--ease-in-out);
        }

        .barcode-scan-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-input-focus);
        }

        .barcode-scan-hint {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--spacing-sm);
        }

        /* 应付金额区域 */
        .payable-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .payable-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background-color: var(--color-neutral-50);
            border-radius: var(--radius-md);
        }

        .payable-label {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .payable-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .payable-change {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* 审核状态区域 */
        .audit-status-section {
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .audit-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background-color: var(--color-neutral-50);
            border-radius: var(--radius-md);
        }

        .audit-status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .audit-status-badge.pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--color-warning);
        }

        .audit-status-badge.approved {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
        }

        .audit-status-badge.rejected {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--color-error);
        }

        .audit-status-badge.none {
            background-color: var(--color-neutral-200);
            color: var(--color-text-secondary);
        }

        /* 操作按钮区域 */
        .action-section {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background-color: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        /* 提示信息 */
        .alert-info {
            padding: var(--spacing-md);
            background-color: rgba(23, 162, 184, 0.1);
            border-left: 4px solid var(--color-info);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .alert-warning {
            padding: var(--spacing-md);
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid var(--color-warning);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        /* 隐藏状态 */
        .hidden {
            display: none;
        }

        /* 新增入库单弹窗 */
        .storage-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .storage-modal-overlay.show { display: flex; }
        .storage-modal {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 92%;
            max-width: 560px;
            overflow: hidden;
        }
        .storage-modal .modal-head {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .storage-modal .modal-head h3 { margin: 0; font-size: var(--font-size-lg); }
        .storage-modal .modal-body {
            padding: var(--spacing-lg);
        }
        .storage-modal .modal-foot {
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
        .storage-modal .form-row { display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md); flex-wrap: wrap; }
        .storage-modal .form-group { flex: 1; min-width: 200px; }
        .storage-modal .form-group label { display: block; margin-bottom: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-text-primary); }
        .storage-modal .form-group input, .storage-modal .form-group select, .storage-modal .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
        .storage-modal .form-group textarea { min-height: 60px; resize: vertical; }
    </style>
</head>
<body>
    <div class="purchase-storage-page">
        <!-- 页面标题 -->
        <div class="page-header">
            <div>
                <h1 class="page-title">采购入库</h1>
                <div class="page-subtitle">选择采购订单，匹配条码入库，提交财务审核</div>
            </div>
        </div>

        <!-- 订单选择区域 -->
        <div class="order-select-section">
            <div class="order-select-header">
                <label class="order-select-label">选择采购订单：</label>
                <div class="order-select-wrapper">
                    <input type="text" 
                           class="order-select-input" 
                           id="orderSearchInput" 
                           placeholder="请输入订单号或往来单位搜索"
                           list="orderList">
                    <datalist id="orderList">
                        <!-- 选项由JS动态生成 -->
                    </datalist>
                    <button class="btn btn-outline" id="selectOrderBtn">选择</button>
                    <button class="btn btn-text" id="clearOrderBtn">清空</button>
                    <button class="btn btn-primary" id="addStorageBtn">新增入库单</button>
                </div>
            </div>
            
            <!-- 条码设置 -->
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-neutral-200);">
                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                    <input type="checkbox" id="barcodeRequiredCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: var(--font-size-sm); color: var(--color-text-primary);">强制条码录入</span>
                </label>
                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">（开启后，所有商品必须录入条码才能提交审核）</span>
            </div>

            <!-- 订单信息卡片（选中订单后显示） -->
            <div id="orderInfoCard" class="order-info-card hidden">
                <div class="order-info-item">
                    <span class="order-info-label">订单单号</span>
                    <span class="order-info-value" id="orderIdDisplay">-</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">订单日期</span>
                    <span class="order-info-value" id="orderDateDisplay">-</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">往来单位</span>
                    <span class="order-info-value" id="orderPartnerDisplay">-</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">项目</span>
                    <span class="order-info-value" id="orderProjectDisplay">-</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">订单金额</span>
                    <span class="order-info-value" id="orderAmountDisplay">-</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">应付余额</span>
                    <span class="order-info-value" id="orderPayableDisplay">-</span>
                </div>
            </div>
        </div>

        <!-- 商品明细表格 -->
        <div class="products-section" id="productsSection" style="display: none;">
            <h2 class="section-title">商品明细</h2>
            
            <!-- 条码强制提示 -->
            <div class="alert-warning" id="barcodeRequiredAlert" style="display: none;">
                <strong>注意：</strong>当前设置为强制条码录入，所有商品必须录入条码后才能提交审核。
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>商品名称</th>
                            <th>规格</th>
                            <th>单位</th>
                            <th class="text-right">订单数量</th>
                            <th class="text-right">单价</th>
                            <th class="text-right">金额</th>
                            <th>条码</th>
                            <th>条码状态</th>
                            <th class="text-right">入库数量</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- 数据由JavaScript动态生成 -->
                    </tbody>
                    <tfoot>
                        <tr style="background-color: var(--color-neutral-50); font-weight: var(--font-weight-medium);">
                            <td colspan="4" class="text-right">合计：</td>
                            <td class="text-right" id="totalOrderQty">0.00</td>
                            <td colspan="2"></td>
                            <td colspan="2"></td>
                            <td class="text-right" id="totalStorageQty">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- 条码扫描区域 -->
        <div class="barcode-scan-section" id="barcodeScanSection" style="display: none;">
            <h2 class="section-title">条码扫描</h2>
            <div class="barcode-scan-box">
                <input type="text" 
                       class="barcode-scan-input" 
                       id="barcodeScanInput" 
                       placeholder="请扫描或手动输入商品条码，按回车键匹配">
                <button class="btn btn-primary" id="scanBarcodeBtn">扫描</button>
            </div>
            <div class="barcode-scan-hint">
                提示：扫描条码后会自动匹配到对应的商品行，如果商品已存在条码，将自动填充。
            </div>
        </div>

        <!-- 应付金额区域 -->
        <div class="payable-section" id="payableSection" style="display: none;">
            <h2 class="section-title">应付金额</h2>
            <div class="payable-info">
                <div>
                    <div class="payable-label">应付金额</div>
                    <div class="payable-change" id="payableChange">入库后将增加应付金额</div>
                </div>
                <div class="payable-value" id="payableValue">¥0.00</div>
            </div>
        </div>

        <!-- 审核状态区域 -->
        <div class="audit-status-section" id="auditStatusSection" style="display: none;">
            <h2 class="section-title">审核状态</h2>
            <div class="audit-status">
                <span class="audit-status-badge none" id="auditStatusBadge">未提交</span>
                <span id="auditStatusText">请完成商品明细和条码录入后提交财务审核</span>
            </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="action-section" id="actionSection" style="display: none;">
            <button class="btn btn-outline" id="resetBtn">重置</button>
            <button class="btn btn-primary" id="submitAuditBtn">提交财务审核</button>
        </div>

        <!-- 新增入库单弹窗 -->
        <div class="storage-modal-overlay" id="storageModalOverlay">
            <div class="storage-modal">
                <div class="modal-head">
                    <h3>新增入库单</h3>
                    <button type="button" class="btn btn-text" id="storageModalClose">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 1 100%;">
                            <label>采购订单</label>
                            <select id="storageOrderSelect"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>入库日期</label>
                            <input type="date" id="storageDate">
                        </div>
                        <div class="form-group">
                            <label>入库仓库</label>
                            <select id="storageWarehouse">
                                <option value="总仓">总仓</option>
                                <option value="分仓A">分仓A</option>
                                <option value="分仓B">分仓B</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>经手人</label>
                            <input type="text" id="storageStaff" placeholder="选填">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 1 100%;">
                            <label>备注</label>
                            <textarea id="storageRemark" placeholder="选填"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-foot">
                    <button type="button" class="btn btn-text" id="storageModalCancel">取消</button>
                    <button type="button" class="btn btn-primary" id="storageModalConfirm">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟采购订单数据（从采购订单页面获取）
        const purchaseOrders = [
            {
                id: 'JH20250826001',
                date: '2025-08-26',
                partner: '雅安本地供应商A',
                project: '雅安好物进货',
                amount: 1800.20,
                payable: 800.00,
                products: [
                    { id: 1, name: '蒙顶山茶叶', spec: '500g/盒', unit: '盒', qty: 20, price: 45.00, barcode: '6901234567890' },
                    { id: 2, name: '雅安花椒', spec: '250g/袋', unit: '袋', qty: 30, price: 28.00, barcode: '6901234567891' },
                    { id: 3, name: '雅安腊肉', spec: '500g/包', unit: '包', qty: 15, price: 38.00, barcode: '' }
                ]
            },
            {
                id: 'JH20250826002',
                date: '2025-08-26',
                partner: '成都批发商B',
                project: '旅游周边补货',
                amount: 1200.00,
                payable: 560.00,
                products: [
                    { id: 4, name: '熊猫玩偶', spec: '20cm', unit: '个', qty: 50, price: 15.00, barcode: '6901234567892' },
                    { id: 5, name: '雅安明信片', spec: '一套10张', unit: '套', qty: 30, price: 12.00, barcode: '6901234567893' }
                ]
            },
            {
                id: 'JH20250827001',
                date: '2025-08-27',
                partner: '雅安本地供应商C',
                project: '节庆活动备货',
                amount: 2300.50,
                payable: 1500.00,
                products: [
                    { id: 6, name: '雅安特产礼盒', spec: '1kg装', unit: '盒', qty: 25, price: 88.00, barcode: '6901234567894' },
                    { id: 7, name: '雅安蜂蜜', spec: '500g/瓶', unit: '瓶', qty: 40, price: 35.00, barcode: '' }
                ]
            }
        ];

        // 当前选中的订单
        let selectedOrder = null;
        // 当前入库的商品明细（包含条码和入库数量）
        let storageItems = [];
        // 是否强制条码录入
        let barcodeRequired = false;
        // 审核状态：none-未提交, pending-审核中, approved-已通过, rejected-已拒绝
        let auditStatus = 'none';

        // 初始化订单列表
        function initOrderList() {
            const datalist = document.getElementById('orderList');
            datalist.innerHTML = '';
            purchaseOrders.forEach(order => {
                const option = document.createElement('option');
                option.value = `${order.id} - ${order.partner}`;
                option.dataset.orderId = order.id;
                datalist.appendChild(option);
            });
        }

        // 选择订单
        function selectOrder(orderId) {
            selectedOrder = purchaseOrders.find(o => o.id === orderId);
            if (!selectedOrder) {
                alert('未找到该订单');
                return;
            }

            // 显示订单信息
            document.getElementById('orderIdDisplay').textContent = selectedOrder.id;
            document.getElementById('orderDateDisplay').textContent = selectedOrder.date;
            document.getElementById('orderPartnerDisplay').textContent = selectedOrder.partner;
            document.getElementById('orderProjectDisplay').textContent = selectedOrder.project;
            document.getElementById('orderAmountDisplay').textContent = `¥${selectedOrder.amount.toFixed(2)}`;
            document.getElementById('orderPayableDisplay').textContent = `¥${selectedOrder.payable.toFixed(2)}`;
            document.getElementById('orderInfoCard').classList.remove('hidden');

            // 初始化入库商品明细
            storageItems = selectedOrder.products.map(product => ({
                ...product,
                storageQty: product.qty,
                scannedBarcode: product.barcode || ''
            }));

            // 显示商品明细表格
            renderProductsTable();
            document.getElementById('productsSection').style.display = 'block';
            document.getElementById('barcodeScanSection').style.display = 'block';
            document.getElementById('payableSection').style.display = 'block';
            document.getElementById('auditStatusSection').style.display = 'block';
            document.getElementById('actionSection').style.display = 'flex';

            // 更新应付金额
            updatePayable();
        }

        // 渲染商品明细表格
        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            let totalOrderQty = 0;
            let totalStorageQty = 0;

            storageItems.forEach((item, index) => {
                totalOrderQty += item.qty;
                totalStorageQty += item.storageQty || 0;

                const row = document.createElement('tr');
                row.dataset.productId = item.id;
                row.dataset.index = index;
                
                const barcodeValue = item.scannedBarcode || '';
                const isMatched = barcodeValue && item.barcode && barcodeValue === item.barcode;
                const barcodeClass = barcodeRequired && !barcodeValue ? 'required' : '';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.unit}</td>
                    <td class="text-right">${item.qty.toFixed(2)}</td>
                    <td class="text-right">¥${item.price.toFixed(2)}</td>
                    <td class="text-right">¥${(item.qty * item.price).toFixed(2)}</td>
                    <td>
                        <input type="text" 
                               class="barcode-input ${barcodeClass}" 
                               data-product-id="${item.id}"
                               data-index="${index}"
                               value="${barcodeValue}"
                               placeholder="${barcodeRequired ? '必填' : '可选'}">
                    </td>
                    <td>
                        <span class="barcode-status ${isMatched ? 'matched' : barcodeValue ? 'unmatched' : ''}">
                            ${isMatched ? '✓ 已匹配' : barcodeValue ? '✗ 未匹配' : '未录入'}
                        </span>
                    </td>
                    <td class="text-right">
                        <input type="number" 
                               class="form-input" 
                               style="width: 100px; text-align: right; padding: var(--spacing-xs) var(--spacing-sm); border: 1px solid var(--color-neutral-300); border-radius: var(--radius-md); font-size: var(--font-size-sm);"
                               data-product-id="${item.id}"
                               data-index="${index}"
                               value="${item.storageQty.toFixed(2)}"
                               min="0"
                               max="${item.qty}"
                               step="0.01">
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalOrderQty').textContent = totalOrderQty.toFixed(2);
            document.getElementById('totalStorageQty').textContent = totalStorageQty.toFixed(2);

            // 显示/隐藏强制条码提示
            const alert = document.getElementById('barcodeRequiredAlert');
            if (barcodeRequired) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }

            // 绑定条码输入事件
            bindBarcodeInputs();
            // 绑定入库数量输入事件
            bindStorageQtyInputs();
        }

        // 绑定条码输入事件
        function bindBarcodeInputs() {
            document.querySelectorAll('.barcode-input').forEach(input => {
                input.addEventListener('input', function() {
                    const productId = parseInt(this.dataset.productId);
                    const index = parseInt(this.dataset.index);
                    const barcode = this.value.trim();
                    
                    storageItems[index].scannedBarcode = barcode;
                    
                    // 检查是否匹配
                    const item = storageItems[index];
                    const isMatched = barcode && item.barcode && barcode === item.barcode;
                    
                    // 更新状态显示
                    const row = this.closest('tr');
                    const statusCell = row.querySelector('.barcode-status');
                    if (isMatched) {
                        statusCell.className = 'barcode-status matched';
                        statusCell.textContent = '✓ 已匹配';
                        this.classList.remove('required');
                    } else if (barcode) {
                        statusCell.className = 'barcode-status unmatched';
                        statusCell.textContent = '✗ 未匹配';
                        if (barcodeRequired) {
                            this.classList.add('required');
                        }
                    } else {
                        statusCell.className = 'barcode-status';
                        statusCell.textContent = '未录入';
                        if (barcodeRequired) {
                            this.classList.add('required');
                        } else {
                            this.classList.remove('required');
                        }
                    }

                    // 检查是否可以提交
                    checkCanSubmit();
                });

                input.addEventListener('blur', function() {
                    if (barcodeRequired && !this.value.trim()) {
                        this.classList.add('required');
                    }
                });
            });
        }

        // 绑定入库数量输入事件
        function bindStorageQtyInputs() {
            document.querySelectorAll('input[type="number"][data-product-id]').forEach(input => {
                input.addEventListener('input', function() {
                    const productId = parseInt(this.dataset.productId);
                    const index = parseInt(this.dataset.index);
                    const qty = parseFloat(this.value) || 0;
                    const maxQty = storageItems[index].qty;
                    
                    if (qty > maxQty) {
                        this.value = maxQty.toFixed(2);
                        storageItems[index].storageQty = maxQty;
                    } else if (qty < 0) {
                        this.value = '0.00';
                        storageItems[index].storageQty = 0;
                    } else {
                        storageItems[index].storageQty = qty;
                    }

                    // 更新合计
                    updateTotals();
                    // 更新应付金额
                    updatePayable();
                });
            });
        }

        // 更新合计
        function updateTotals() {
            let totalStorageQty = 0;
            storageItems.forEach(item => {
                totalStorageQty += item.storageQty || 0;
            });
            document.getElementById('totalStorageQty').textContent = totalStorageQty.toFixed(2);
        }

        // 更新应付金额
        function updatePayable() {
            if (!selectedOrder) return;

            let totalAmount = 0;
            storageItems.forEach(item => {
                totalAmount += (item.storageQty || 0) * item.price;
            });

            const originalPayable = selectedOrder.payable;
            const newPayable = originalPayable + totalAmount;
            const change = totalAmount;

            document.getElementById('payableValue').textContent = `¥${newPayable.toFixed(2)}`;
            
            if (change > 0) {
                document.getElementById('payableChange').textContent = `入库后将增加应付金额 ¥${change.toFixed(2)}`;
                document.getElementById('payableChange').style.color = 'var(--color-error)';
            } else {
                document.getElementById('payableChange').textContent = '应付金额无变化';
                document.getElementById('payableChange').style.color = 'var(--color-text-secondary)';
            }
        }

        // 检查是否可以提交
        function checkCanSubmit() {
            if (!selectedOrder) {
                return false;
            }

            if (barcodeRequired) {
                // 检查是否所有商品都录入了条码
                const allBarcoded = storageItems.every(item => item.scannedBarcode && item.scannedBarcode.trim());
                return allBarcoded;
            }

            return true;
        }

        // 扫描条码
        function scanBarcode(barcode) {
            if (!barcode || !barcode.trim()) {
                return;
            }

            // 查找匹配的商品
            const matchedItem = storageItems.find(item => item.barcode === barcode.trim());
            
            if (matchedItem) {
                // 找到匹配的商品，自动填充条码
                const index = storageItems.findIndex(item => item.id === matchedItem.id);
                storageItems[index].scannedBarcode = barcode.trim();
                
                // 重新渲染表格
                renderProductsTable();
                
                // 高亮显示匹配的行
                const row = document.querySelector(`tr[data-product-id="${matchedItem.id}"]`);
                if (row) {
                    row.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);
                }
            } else {
                alert('未找到匹配的商品条码，请检查条码是否正确');
            }
        }

        // 提交财务审核
        function submitAudit() {
            if (!selectedOrder) {
                alert('请先选择采购订单');
                return;
            }

            // 检查条码（如果强制）
            if (barcodeRequired) {
                const missingBarcode = storageItems.find(item => !item.scannedBarcode || !item.scannedBarcode.trim());
                if (missingBarcode) {
                    alert('请为所有商品录入条码后再提交审核');
                    return;
                }
            }

            // 检查入库数量
            const hasStorageQty = storageItems.some(item => item.storageQty > 0);
            if (!hasStorageQty) {
                alert('请至少录入一个商品的入库数量');
                return;
            }

            if (!confirm('确定要提交财务审核吗？提交后将无法修改。')) {
                return;
            }

            // 更新审核状态
            auditStatus = 'pending';
            updateAuditStatus();
            
            // 模拟审核流程（3秒后自动通过）
            setTimeout(() => {
                auditStatus = 'approved';
                updateAuditStatus();
                
                // 更新应付金额
                updatePayable();
                
                alert('审核已通过！入库成功，应付金额已更新。');
            }, 3000);
        }

        // 更新审核状态
        function updateAuditStatus() {
            const badge = document.getElementById('auditStatusBadge');
            const text = document.getElementById('auditStatusText');

            badge.className = 'audit-status-badge ' + auditStatus;
            
            switch(auditStatus) {
                case 'none':
                    badge.textContent = '未提交';
                    text.textContent = '请完成商品明细和条码录入后提交财务审核';
                    break;
                case 'pending':
                    badge.textContent = '审核中';
                    text.textContent = '已提交财务审核，请等待审核结果...';
                    break;
                case 'approved':
                    badge.textContent = '审核通过';
                    text.textContent = '审核已通过，入库成功！应付金额已更新。';
                    break;
                case 'rejected':
                    badge.textContent = '审核拒绝';
                    text.textContent = '审核未通过，请检查后重新提交。';
                    break;
            }

            // 更新提交按钮状态
            const submitBtn = document.getElementById('submitAuditBtn');
            if (auditStatus === 'pending' || auditStatus === 'approved') {
                submitBtn.disabled = true;
                submitBtn.textContent = auditStatus === 'approved' ? '已审核通过' : '审核中...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = '提交财务审核';
            }
        }

        // 重置表单
        function resetForm() {
            if (!confirm('确定要重置吗？所有已录入的数据将丢失。')) {
                return;
            }

            selectedOrder = null;
            storageItems = [];
            auditStatus = 'none';

            document.getElementById('orderSearchInput').value = '';
            document.getElementById('orderInfoCard').classList.add('hidden');
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('barcodeScanSection').style.display = 'none';
            document.getElementById('payableSection').style.display = 'none';
            document.getElementById('auditStatusSection').style.display = 'none';
            document.getElementById('actionSection').style.display = 'none';
            document.getElementById('barcodeScanInput').value = '';
            
            updateAuditStatus();
        }

        // 事件绑定
        document.getElementById('selectOrderBtn').addEventListener('click', function() {
            const input = document.getElementById('orderSearchInput');
            const value = input.value.trim();
            
            if (!value) {
                alert('请输入订单号');
                return;
            }

            // 从输入值中提取订单号
            let orderId = value;
            if (value.includes(' - ')) {
                orderId = value.split(' - ')[0];
            }

            selectOrder(orderId);
        });

        document.getElementById('orderSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('selectOrderBtn').click();
            }
        });

        document.getElementById('clearOrderBtn').addEventListener('click', resetForm);

        // 新增入库单弹窗
        const storageModalEl = document.getElementById('storageModalOverlay');
        const storageOrderSelect = document.getElementById('storageOrderSelect');
        const storageDateInput = document.getElementById('storageDate');
        const storageWarehouseSelect = document.getElementById('storageWarehouse');
        const storageStaffInput = document.getElementById('storageStaff');
        const storageRemarkInput = document.getElementById('storageRemark');

        function openStorageModal() {
            const today = new Date().toISOString().slice(0, 10);
            storageOrderSelect.innerHTML = '<option value="">请选择采购订单</option>';
            purchaseOrders.forEach(function (o) {
                const opt = document.createElement('option');
                opt.value = o.id;
                opt.textContent = o.id + ' - ' + o.partner + ' (¥' + o.amount.toFixed(2) + ')';
                storageOrderSelect.appendChild(opt);
            });
            storageDateInput.value = today;
            storageWarehouseSelect.value = '总仓';
            storageStaffInput.value = '';
            storageRemarkInput.value = '';
            storageModalEl.classList.add('show');
        }

        function closeStorageModal() {
            storageModalEl.classList.remove('show');
        }

        document.getElementById('addStorageBtn').addEventListener('click', openStorageModal);
        document.getElementById('storageModalClose').addEventListener('click', closeStorageModal);
        document.getElementById('storageModalCancel').addEventListener('click', closeStorageModal);
        storageModalEl.addEventListener('click', function (e) {
            if (e.target === storageModalEl) closeStorageModal();
        });
        document.getElementById('storageModalConfirm').addEventListener('click', function () {
            const orderId = storageOrderSelect.value;
            if (!orderId) {
                alert('请选择采购订单');
                return;
            }
            selectOrder(orderId);
            closeStorageModal();
        });

        document.getElementById('barcodeScanInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const barcode = this.value.trim();
                if (barcode) {
                    scanBarcode(barcode);
                    this.value = '';
                }
            }
        });

        document.getElementById('scanBarcodeBtn').addEventListener('click', function() {
            const input = document.getElementById('barcodeScanInput');
            const barcode = input.value.trim();
            if (barcode) {
                scanBarcode(barcode);
                input.value = '';
            }
        });

        document.getElementById('submitAuditBtn').addEventListener('click', submitAudit);
        document.getElementById('resetBtn').addEventListener('click', resetForm);

        // 强制条码录入开关
        document.getElementById('barcodeRequiredCheckbox').addEventListener('change', function() {
            barcodeRequired = this.checked;
            
            // 如果已选择订单，重新渲染表格以更新必填状态
            if (selectedOrder) {
                renderProductsTable();
                checkCanSubmit();
            }
        });

        // 初始化
        initOrderList();
        updateAuditStatus();
    </script>
</body>
</html>